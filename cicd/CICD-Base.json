{"status":{},"spec":{"description":"jenkins master: http:\/\/@@{JenkinsMasterVM.address}@@:8080\/\njenkins credential: admin\/@@{JenkinsMasterVM.jenkins_authorization}@@\n\ndev workstation: @@{WorkstationVM.address}@@","resources":{"client_attrs":{"None":{"y":-68.6240759861,"x":233.5880736589},"aa65c031_deployment_cloned_1":{"y":17.1602822234,"x":-162.1742151584},"8cafc62e_deployment":{"y":-68.6240759861,"x":233.5880736589},"8cafc62e_deployment_cloned_1":{"y":-255.1142895662,"x":-358.7870924921},"fe95f237_deployment":{"y":262.3104958304,"x":39.0147129281},"1afa7711_deployment":{"y":-253,"x":35.4285714286},"aa65c031_deployment":{"y":117.1420771497,"x":426.2469998061}},"service_definition_list":[{"singleton":false,"action_list":[{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Pull Artifactory Contianer"},{"kind":"app_task","name":"Start Artifactory"},{"kind":"app_task","name":"Configure Artifactory"}],"name":"20fc7eb7_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Pull Artifactory Contianer"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Start Artifactory"}},{"from_task_reference":{"kind":"app_task","name":"Start Artifactory"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Configure Artifactory"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Artifactory"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Pull Artifactory Contianer","attrs":{"exit_status":[],"script":"docker pull docker.bintray.io\/jfrog\/artifactory-oss\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Artifactory"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Start Artifactory","attrs":{"exit_status":[],"script":"set -x\n\ndocker run --name artifactory -d -p 8081:8081 docker.bintray.io\/jfrog\/artifactory-oss:latest","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Artifactory"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Configure Artifactory","attrs":{"exit_status":[],"script":"set -x\n\necho \"Initialize Artifactory @@{initial_project_name}@@ Repository\"\n\necho 'localRepositories:\n  @@{initial_project_name}@@-local-repo:\n    type: generic\n    checksumPolicyType: server-generated-checksums\n    description: \"Devops @@{initial_project_name}@@ Artifact Repository\"\n    dockerApiVersion: V2\n    excludesPattern:\n    includesPattern:\n    maxUniqueSnapshots: 0\n    maxUniqueTags: 0\n    repoLayout: simple-default\n    snapshotVersionBehavior: unique\n    blackedOut: false\n    enableFileListsIndexing: false\n    forceNugetAuthentication: false\n    handleReleases: true\n    handleSnapshots: true\n    suppressPomConsistencyChecks: true' > ~\/artifactory-repo-config.yml\n \nsleep 90\n \ncurl -u admin:password -X PATCH \"http:\/\/localhost:8081\/artifactory\/api\/system\/configuration\" -H \u201cContent-Type:application\/yaml\u201d -T ~\/artifactory-repo-config.yml\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"af31aac3_runbook","main_task_local_reference":{"kind":"app_task","name":"20fc7eb7_dag"},"variable_list":[]},"name":"Artifactory Installation"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Configure User"}],"name":"84e2678e_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Artifactory"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Configure User","attrs":{"exit_status":[],"script":"mkdir ~\/.ssh\nchmod 700 ~\/.ssh\necho 'set -o vi' >> ~\/.bashrc\necho 'StrictHostKeyChecking no' > ~\/.ssh\/config\n\necho \"Create SSH Keys\"\necho \"@@{Nutanix Key.secret}@@\" > ~\/.ssh\/id_rsa\necho \"@@{nutanix_public_key}@@\" > ~\/.ssh\/id_rsa.pub\nchmod 600 ~\/.ssh\/id_rsa*\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"a7befc49_runbook_cloned_1","main_task_local_reference":{"kind":"app_task","name":"84e2678e_dag"},"variable_list":[]},"name":"Configure Connectivity"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Install Docker"},{"kind":"app_task","name":"Install Docker Compose"}],"name":"88fffde0_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Install Docker"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Install Docker Compose"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Artifactory"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Install Docker","attrs":{"exit_status":[],"script":"echo \"** Downloading Docker Repo Key...\"\ncurl -fsSL https:\/\/download.docker.com\/linux\/ubuntu\/gpg | sudo apt-key add -\n\necho \"** Adding Docker Repo...\"\nsudo add-apt-repository \"deb [arch=amd64] https:\/\/download.docker.com\/linux\/ubuntu $(lsb_release -cs) stable\"\n\necho \"** Apt Update...\"\nsudo apt-get update\nsudo apt-get install -y sshpass\n\necho \"** Set apt-cache policy for docker-ce...\"\napt-cache policy docker-ce\n\necho \"** Installing Docker CE...\"\nsudo apt-get install -y docker-ce\n\necho \"** Adding current user to docker group...\"\nsudo usermod -aG docker @@{Ubuntu Credential.username}@@\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Artifactory"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Install Docker Compose","attrs":{"exit_status":[],"script":"echo \"** Installing python-pip...\"\nsudo apt-get -y install python-pip\n\necho \"** Upgrade pip...\"\nsudo pip install --upgrade pip\n\necho \"** Install docker-compose...\"\nsudo pip install docker-compose","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"350f897b_runbook","main_task_local_reference":{"kind":"app_task","name":"88fffde0_dag"},"variable_list":[]},"name":"Docker Installation"},{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Artifactory"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Configure Connectivity"}],"name":"6b546dea_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Artifactory"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Configure Connectivity","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"a7befc49_runbook_cloned_1"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"fb911f31_runbook_cloned_1","main_task_local_reference":{"kind":"app_task","name":"6b546dea_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Artifactory"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"be256f71_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"bed2d16c_runbook_cloned_1","main_task_local_reference":{"kind":"app_task","name":"be256f71_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Artifactory"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"38cd3275_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"d7e997fb_runbook_cloned_1","main_task_local_reference":{"kind":"app_task","name":"38cd3275_dag"},"variable_list":[]},"name":"action_restart"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Artifactory"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"bc0993e2_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"9b3a9a95_runbook_cloned_1","main_task_local_reference":{"kind":"app_task","name":"bc0993e2_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Artifactory"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"04085076_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"7f5595ea_runbook_cloned_1","main_task_local_reference":{"kind":"app_task","name":"04085076_dag"},"variable_list":[]},"name":"action_stop"}],"depends_on_list":[],"name":"Artifactory","port_list":[],"tier":"","variable_list":[{"val_type":"STRING","description":"","name":"artifact_server","type":"LOCAL","value":"http:\/\/10.1.176.73\/artifacts","label":"","attrs":{"type":""}}],"description":""},{"singleton":false,"action_list":[{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Load Cert"},{"kind":"app_task","name":"Configure User"}],"name":"84e2678e_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Load Cert"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Configure User"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Developer Workstation"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Load Cert","attrs":{"exit_status":[],"script":"echo \"Create host entries\"\necho \"@@{Docker Registry.address}@@ @@{Docker Registry.name}@@.@@{domain_name}@@ @@{Docker Registry.name}@@\" | sudo tee -a \/etc\/hosts\necho \"@@{Gitolite.address}@@ @@{Gitolite.name}@@.@@{domain_name}@@ @@{Gitolite.name}@@\" | sudo tee -a \/etc\/hosts\necho \"@@{Artifactory.address}@@ artifactory.@@{domain_name}@@ artifactory\" | sudo tee -a \/etc\/hosts\n\necho \"Load Cert\"\nsudo mkdir \/usr\/local\/share\/ca-certificates\/docker-dev-cert\nREGISTRY_IP=@@{Docker Registry.address}@@\nsshpass -p @@{Ubuntu Credential.secret}@@ scp -oStrictHostKeyChecking=no ${REGISTRY_IP}:~\/devdockerCA.crt \/tmp\nsudo mv \/tmp\/devdockerCA.crt \/usr\/local\/share\/ca-certificates\/docker-dev-cert\/devdockerCA.crt\nsudo update-ca-certificates\nsudo service docker restart","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Developer Workstation"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Configure User","attrs":{"exit_status":[],"script":"sudo apt-get update\nmkdir ~\/.ssh\nchmod 700 ~\/.ssh\necho 'set -o vi' >> ~\/.bashrc\necho 'export DOCKER_REGISTRY=@@{Docker Registry.name}@@.@@{domain_name}@@' >> ~\/.bashrc\necho 'StrictHostKeyChecking no' > ~\/.ssh\/config\n\necho \"Create SSH Keys\"\necho \"@@{Nutanix Key.secret}@@\" > ~\/.ssh\/id_rsa\necho \"@@{nutanix_public_key}@@\" > ~\/.ssh\/id_rsa.pub\nchmod 600 ~\/.ssh\/id_rsa*\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"a7befc49_runbook","main_task_local_reference":{"kind":"app_task","name":"84e2678e_dag"},"variable_list":[]},"name":"Configure Connectivity"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Install Docker"},{"kind":"app_task","name":"Install Docker Compose"}],"name":"af15a349_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Install Docker"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Install Docker Compose"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Developer Workstation"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Install Docker","attrs":{"exit_status":[],"script":"set -x\n\necho \"** Downloading Docker Repo Key...\"\ncurl -fsSL https:\/\/download.docker.com\/linux\/ubuntu\/gpg | sudo apt-key add -\n\necho \"** Adding Docker Repo...\"\nsudo add-apt-repository \"deb [arch=amd64] https:\/\/download.docker.com\/linux\/ubuntu $(lsb_release -cs) stable\"\n\necho \"** Apt Update...\"\nsudo apt-get update\nsudo apt-get install -y sshpass\n\necho \"** Set apt-cache policy for docker-ce...\"\napt-cache policy docker-ce\n\necho \"** Installing Docker CE...\"\nsudo apt-get install -y docker-ce\n\necho \"** Adding current user to docker group...\"\nsudo usermod -aG docker @@{Ubuntu Credential.username}@@\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Developer Workstation"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Install Docker Compose","attrs":{"exit_status":[],"script":"echo \"** Installing python-pip...\"\nsudo apt-get -y install python-pip\n\necho \"** Upgrade pip...\"\nsudo pip install --upgrade pip\n\necho \"** Install docker-compose...\"\nsudo pip install docker-compose","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"4d4b18fe_runbook","main_task_local_reference":{"kind":"app_task","name":"af15a349_dag"},"variable_list":[]},"name":"Docker Installation"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Install NodeJS"}],"name":"ace9b0ce_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Developer Workstation"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Install NodeJS","attrs":{"exit_status":[],"script":"curl -sL https:\/\/deb.nodesource.com\/setup_8.x -o nodesource_setup.sh\nsudo bash nodesource_setup.sh\nsudo apt-get install -y nodejs","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"ffab2e14_runbook","main_task_local_reference":{"kind":"app_task","name":"ace9b0ce_dag"},"variable_list":[]},"name":"NodeJS Installation"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Jenkins Master Details"},{"kind":"app_task","name":"Developer Workstation Details"},{"kind":"app_task","name":"Docker Repository Details"},{"kind":"app_task","name":"Artifactory Details"}],"name":"817f2161_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Developer Workstation Details"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Docker Repository Details"}},{"from_task_reference":{"kind":"app_task","name":"Docker Repository Details"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Artifactory Details"}},{"from_task_reference":{"kind":"app_task","name":"Jenkins Master Details"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Developer Workstation Details"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Developer Workstation"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Jenkins Master Details","attrs":{"script":"print \"-------------------------\"\nprint \"\"\nprint \"Jenkins Master Host Name:\"\nprint \"@@{Jenkins Master.name}@@\"\nprint \"\"\nprint \"Jenkins Master IP Address:\"\nprint \"@@{Jenkins Master.address}@@\"\nprint \"\"\nprint \"Initial Authorization Password:\"\nprint \"@@{Jenkins Master.jenkins_authorization}@@\"\nprint \"\"\nprint \"Jenkins Master URL:\"\nprint \"http:\/\/@@{Jenkins Master.address}@@:8080\/\"\nprint \"\"\nprint \"-------------------------\"","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Developer Workstation"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Developer Workstation Details","attrs":{"script":"print \"-------------------------\"\nprint \"\"\nprint \"Developer Workstaion Host Name:\"\nprint \"@@{name}@@\"\nprint \"\"\nprint \"Developer Workstaion IP Address:\"\nprint \"@@{address}@@\"\nprint \"\"\nprint \"-------------------------\"","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Developer Workstation"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Docker Repository Details","attrs":{"script":"print \"-------------------------\"\nprint \"\"\nprint \"Docker Registry Host Name:\"\nprint \"@@{Docker Registry.name}@@\"\nprint \"\"\nprint \"Docker Registry IP Address:\"\nprint \"@@{Docker Registry.address}@@\"\nprint \"\"\nprint \"Docker Registry URLs:\"\nprint \"View Repostitories:\"\nprint \"https:\/\/@@{Docker Registry.address}@@\/v2\/_catalog\"\nprint \"\"\nprint \"View Tags:\"\nprint \"https:\/\/@@{Docker Registry.address}@@\/v2\/<repository>\/tags\/list\"\nprint \"\"\nprint \"For Example\"\nprint \"https:\/\/@@{Docker Registry.address}@@\/v2\/nutanix\/ansible\/tags\/list\"\nprint \"\"\nprint \"-------------------------\"","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Developer Workstation"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Artifactory Details","attrs":{"script":"print \"-------------------------\"\nprint \"\"\nprint \"Artifactory Host Name:\"\nprint \"@@{Artifactory.name}@@\"\nprint \"\"\nprint \"Artifactory IP Address:\"\nprint \"@@{Artifactory.address}@@\"\nprint \"\"\nprint \"Artifactory URL:\"\nprint \"http:\/\/@@{Artifactory.address}@@:8081\/artifactory\/webapp\"\nprint \"\"\nprint \"-------------------------\"","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"0e71b583_runbook","main_task_local_reference":{"kind":"app_task","name":"817f2161_dag"},"variable_list":[]},"name":"Output Connection Details"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Initialize DevOps Repository"},{"kind":"app_task","name":"Download Version 1 Demo Code"},{"kind":"app_task","name":"Create and Push Docker Images"}],"name":"501ff368_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Download Version 1 Demo Code"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Create and Push Docker Images"}},{"from_task_reference":{"kind":"app_task","name":"Initialize DevOps Repository"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Download Version 1 Demo Code"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Developer Workstation"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Initialize DevOps Repository","attrs":{"exit_status":[],"script":"set -x\n\necho \"Initialize @@{initial_project_name}@@ Git Project\"\ngit clone git@@@{Gitolite.name}@@.@@{domain_name}@@:@@{initial_project_name}@@.git\n\ncd @@{initial_project_name}@@\n\ngit config user.name nutanix\ngit config user.email nutanix@@@{name}@@.@@{domain_name}@@\ngit config --global push.default matching\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Developer Workstation"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Download Version 1 Demo Code","attrs":{"exit_status":[],"script":"set -x\nfilename=@@{initial_code_seed}@@\nurl=@@{initial_code_seed_location}@@\nurl=$(echo ${url}|sed 's\/\\\/$\/\/')\n\necho \"Get Demo Code\"\ncd @@{initial_project_name}@@\nwget ${url}\/${filename}\ntar xvfz ${filename}\nrm ${filename}\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Developer Workstation"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Create and Push Docker Images","attrs":{"exit_status":[],"script":"#!\/bin\/bash\nset -x\n\nexport DOCKER_REGISTRY=@@{Docker Registry.name}@@.@@{domain_name}@@\nexport PROJECT_NAME=@@{initial_project_name}@@\necho \"Login into Docker Registry\"\ndocker login -u @@{Docker Registry Credential.username}@@ -p @@{Docker Registry Credential.secret}@@ $DOCKER_REGISTRY\ncd ~\/@@{initial_project_name}@@\n\necho \"Build and Push Ansible Image\"\nwhile true ; do\n  docker build -t ${DOCKER_REGISTRY}\/@@{initial_project_name}@@\/ansible docker-ansible\/src\n  if [ $? -eq 0 ]; then\n    break\n  else\n    sleep 15\n  fi\ndone\ndocker push ${DOCKER_REGISTRY}\/@@{initial_project_name}@@\/ansible\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"e45c29cd_runbook","main_task_local_reference":{"kind":"app_task","name":"501ff368_dag"},"variable_list":[]},"name":"Setup Demo Project"},{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Developer Workstation"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Configure Connectivity"},{"kind":"app_task","name":"Setup Demo Project"}],"name":"6b546dea_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Configure Connectivity"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Setup Demo Project"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Developer Workstation"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Configure Connectivity","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"a7befc49_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Developer Workstation"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Setup Demo Project","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"e45c29cd_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"fb911f31_runbook","main_task_local_reference":{"kind":"app_task","name":"6b546dea_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Developer Workstation"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"be256f71_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"bed2d16c_runbook","main_task_local_reference":{"kind":"app_task","name":"be256f71_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Developer Workstation"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"38cd3275_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"d7e997fb_runbook","main_task_local_reference":{"kind":"app_task","name":"38cd3275_dag"},"variable_list":[]},"name":"action_restart"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Developer Workstation"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Output Connection Details"}],"name":"bc0993e2_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Developer Workstation"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Output Connection Details","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"0e71b583_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"9b3a9a95_runbook","main_task_local_reference":{"kind":"app_task","name":"bc0993e2_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Developer Workstation"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"04085076_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"7f5595ea_runbook","main_task_local_reference":{"kind":"app_task","name":"04085076_dag"},"variable_list":[]},"name":"action_stop"}],"depends_on_list":[{"kind":"app_service","name":"Jenkins Slave"}],"name":"Developer Workstation","port_list":[],"tier":"","variable_list":[],"description":""},{"singleton":false,"action_list":[{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Install Docker"},{"kind":"app_task","name":"Install Docker Compose"}],"name":"c046787c_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Install Docker"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Install Docker Compose"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Docker Registry"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Install Docker","attrs":{"exit_status":[],"script":"set -x\n\necho \"** Downloading Docker Repo Key...\"\ncurl -fsSL https:\/\/download.docker.com\/linux\/ubuntu\/gpg | sudo apt-key add -\n\necho \"** Adding Docker Repo...\"\nsudo add-apt-repository \"deb [arch=amd64] https:\/\/download.docker.com\/linux\/ubuntu $(lsb_release -cs) stable\"\n\necho \"** Apt Update...\"\nsudo apt-get update\n\necho \"** Set apt-cache policy for docker-ce...\"\napt-cache policy docker-ce\n\necho \"** Installing Docker CE...\"\nsudo apt-get install -y docker-ce\n\necho \"** Adding current user to docker group...\"\nsudo usermod -aG docker @@{Ubuntu Credential.username}@@\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Docker Registry"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Install Docker Compose","attrs":{"exit_status":[],"script":"echo \"** Installing python-pip...\"\nsudo apt-get -y install python-pip\n\necho \"** Upgrade pip...\"\nsudo pip install --upgrade pip\n\necho \"** Install docker-compose...\"\nsudo pip install docker-compose","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"991aa9e9_runbook","main_task_local_reference":{"kind":"app_task","name":"c046787c_dag"},"variable_list":[]},"name":"Docker Installation"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Install Docker Registry"},{"kind":"app_task","name":"Setup Init Service"},{"kind":"app_task","name":"Configure Cert"}],"name":"42c7adc3_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Install Docker Registry"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Setup Init Service"}},{"from_task_reference":{"kind":"app_task","name":"Setup Init Service"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Configure Cert"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Docker Registry"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Install Docker Registry","attrs":{"exit_status":[],"script":"sudo apt-get -y install apache2-utils\n\necho \"Creating docker-registry directory...\"\nsudo mkdir -p \/docker-registry\/data \nsudo mkdir -p \/docker-registry\/nginx\n\necho \"Creating docker-registry.yml file...\"\necho 'nginx:\n  image: \"nginx:1.9\"\n  ports:\n    - 443:443\n  links:\n    - registry:registry\n  volumes:\n    - .\/nginx\/:\/etc\/nginx\/conf.d\nregistry:\n  image: registry:2\n  ports:\n    - 127.0.0.1:5000:5000\n  environment:\n    REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY: \/data\n  volumes:\n    - .\/data:\/data' | sudo tee \/docker-registry\/docker-compose.yml\n\necho 'upstream docker-registry {\n  server registry:5000;\n}\n\nserver {\n  listen 443;\n  server_name @@{name}@@.@@{domain_name}@@;\n\n  # SSL\n  ssl on;\n  ssl_certificate \/etc\/nginx\/conf.d\/domain.crt;\n  ssl_certificate_key \/etc\/nginx\/conf.d\/domain.key;\n\n  # disable any limits to avoid HTTP 413 for large image uploads\n  client_max_body_size 0;\n\n  # required to avoid HTTP 411: see Issue #1486 (https:\/\/github.com\/docker\/docker\/issues\/1486)\n  chunked_transfer_encoding on;\n\n  location \/v2\/ {\n    # Do not allow connections from docker 1.5 and earlier\n    if ($http_user_agent ~ \"^(docker\\\/1\\.(3|4|5(?!\\.[0-9]-dev))|Go ).*$\" ) {\n      return 404;\n    }\n\n    # To add basic authentication to v2 use auth_basic setting plus add_header\n    auth_basic \"registry.localhost\";\n    auth_basic_user_file \/etc\/nginx\/conf.d\/registry.password;\n    add_header \"Docker-Distribution-Api-Version\" \"registry\/2.0\" always;\n\n    proxy_pass                          http:\/\/docker-registry;\n    proxy_set_header  Host              $http_host;   \n    proxy_set_header  X-Real-IP         $remote_addr; \n    proxy_set_header  X-Forwarded-For   $proxy_add_x_forwarded_for;\n    proxy_set_header  X-Forwarded-Proto $scheme;\n    proxy_read_timeout                  900;\n  }\n}' | sudo tee \/docker-registry\/nginx\/registry.conf\n\necho \"Create Docker Cert\"\necho @@{Docker Registry Credential.secret}@@ | sudo htpasswd -ci \/docker-registry\/nginx\/registry.password @@{Docker Registry Credential.username}@@ \n\nsudo openssl genrsa -out \/docker-registry\/nginx\/devdockerCA.key 2048\n\nsudo openssl req -x509 -new -nodes -key \/docker-registry\/nginx\/devdockerCA.key -days 10000 -out \/docker-registry\/nginx\/devdockerCA.crt -subj \"\/C=US\/ST=California\/L=San Jose\/O=nutnaix\/OU=DevOps\/CN=@@{name}@@.@@{domain_name}@@\/emailAddress=''\"\n\nsudo openssl genrsa -out \/docker-registry\/nginx\/domain.key 2048\n\nsudo openssl req -new -key \/docker-registry\/nginx\/domain.key -out \/docker-registry\/nginx\/dev-docker-registry.com.csr -subj \"\/C=US\/ST=California\/L=San Jose\/O=nutnaix\/OU=DevOps\/CN=@@{name}@@.@@{domain_name}@@\/emailAddress=''\"\n\nsudo openssl x509 -req -in \/docker-registry\/nginx\/dev-docker-registry.com.csr -CA \/docker-registry\/nginx\/devdockerCA.crt -CAkey \/docker-registry\/nginx\/devdockerCA.key -CAcreateserial -out \/docker-registry\/nginx\/domain.crt -days 10000\n\nsudo mkdir \/usr\/local\/share\/ca-certificates\/docker-dev-cert\nsudo cp \/docker-registry\/nginx\/devdockerCA.crt \/usr\/local\/share\/ca-certificates\/docker-dev-cert\nsudo update-ca-certificates\n\necho \"Restart Docker Service\"\nsudo service docker restart\n\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Docker Registry"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Setup Init Service","attrs":{"exit_status":[],"script":"echo \"Creating Init Script\"\n\necho '[Unit]\nDescription=Docker Application Container Engine\nDocumentation=https:\/\/docs.docker.com\nAfter=network-online.target firewalld.service\nWants=network-online.target\n\n[Service]\nType=notify\n# the default is not to use systemd for cgroups because the delegate issues still\n# exists and systemd currently does not support the cgroup feature set required\n# for containers run by docker\nExecStart=\/usr\/local\/bin\/docker-compose -f \/docker-registry\/docker-compose.yml up -d\nExecReload=\/bin\/kill -s HUP $MAINPID\nLimitNOFILE=1048576\n# Having non-zero Limit*s causes performance problems due to accounting overhead\n# in the kernel. We recommend using cgroups to do container-local accounting.\nLimitNPROC=infinity\nLimitCORE=infinity\n# Uncomment TasksMax if your systemd version supports it.\n# Only systemd 226 and above support this version.\nTasksMax=infinity\nTimeoutStartSec=0\n# set delegate yes so that systemd does not reset the cgroups of docker containers\nDelegate=yes\n# kill only the docker process, not all processes in the cgroup\nKillMode=process\n# restart the docker process if it exits prematurely\nRestart=on-failure\nStartLimitBurst=3\nStartLimitInterval=60s\n\n[Install]\nWantedBy=multi-user.target' | sudo tee \/etc\/systemd\/system\/docker-registry.service \n\necho \"Starting docker-registry Service\"\nsudo service docker-registry start\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Docker Registry"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Configure Cert","attrs":{"exit_status":[],"script":"mkdir ~\/.ssh\nchmod 700 ~\/.ssh\necho \"@@{Nutanix Key.secret}@@\" > ~\/.ssh\/id_rsa\nchmod 600 ~\/.ssh\/id_rsa\necho \"@@{nutanix_public_key}@@\" > ~\/.ssh\/id_rsa.pub\nchmod 600 ~\/.ssh\/id_rsa.pub\nsudo cp \/docker-registry\/nginx\/devdockerCA.crt ~\/\nsudo chown @@{Ubuntu Credential.username}@@:@@{Ubuntu Credential.username}@@ ~\/devdockerCA.crt\nchmod 600 ~\/devdockerCA.crt","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"6a6ef171_runbook","main_task_local_reference":{"kind":"app_task","name":"42c7adc3_dag"},"variable_list":[]},"name":"Docker Registry Installation"},{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Docker Registry"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"ae5e6af0_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"af3d1fe3_runbook_cloned_1","main_task_local_reference":{"kind":"app_task","name":"ae5e6af0_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Docker Registry"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"e92443c7_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"555be4c9_runbook_cloned_1","main_task_local_reference":{"kind":"app_task","name":"e92443c7_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Docker Registry"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"00c19b6d_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"04de4a48_runbook_cloned_1","main_task_local_reference":{"kind":"app_task","name":"00c19b6d_dag"},"variable_list":[]},"name":"action_restart"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Docker Registry"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"117602e2_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"ccc2a1d7_runbook_cloned_1","main_task_local_reference":{"kind":"app_task","name":"117602e2_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Docker Registry"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"6e79884f_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"d6f485c8_runbook_cloned_1","main_task_local_reference":{"kind":"app_task","name":"6e79884f_dag"},"variable_list":[]},"name":"action_stop"}],"depends_on_list":[],"name":"Docker Registry","port_list":[],"tier":"","variable_list":[],"description":""},{"singleton":false,"action_list":[{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Configure Project Access"},{"kind":"app_task","name":"Init Demo Repository"}],"name":"7a9c8308_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Configure Project Access"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Init Demo Repository"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Gitolite"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Configure Project Access","attrs":{"exit_status":[],"script":"\necho \"Create Key File\"\necho @@{jenkins_public_key}@@ >> ~\/gitolite-admin\/keydir\/jenkins.pub \n\necho \"Configure @@{initial_project_name}@@ Repository Access\"\necho \"repo @@{initial_project_name}@@\" >> ~\/gitolite-admin\/conf\/gitolite.conf\necho \"    RW+     =   @all\" >> ~\/gitolite-admin\/conf\/gitolite.conf \necho \"    R       =   jenkins\" >> ~\/gitolite-admin\/conf\/gitolite.conf \n\necho \"Check IN and Commit Changes\"\ncd gitolite-admin\ngit add keydir\/jenkins.pub\ngit add conf\/gitolite.conf\ngit config --global user.name nutanix\ngit config --global user.email nutanix@gso.lab\ngit config --global push.default matching\ngit commit -m \"Added Jenkins\"\ngit push origin master\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Gitolite"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Init Demo Repository","attrs":{"exit_status":[],"script":"echo \"Create and Configure Repository\"\nsudo su -c 'mkdir ~\/repositories\/devops.git' - git\nsudo su -c 'cd ~\/repositories\/devops.git && git init --bare' - git\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"45466435_runbook","main_task_local_reference":{"kind":"app_task","name":"7a9c8308_dag"},"variable_list":[]},"name":"Configure Demo Project"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Install Gitolite"}],"name":"c8a23c68_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Gitolite"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Install Gitolite","attrs":{"exit_status":[],"script":"sudo apt-get update\nmkdir ~\/.ssh\nchmod 700 ~\/.ssh\necho 'set -o vi' >> ~\/.bashrc\necho 'StrictHostKeyChecking no' > ~\/.ssh\/config\n\necho \"Create SSH Keys\"\necho \"@@{Nutanix Key.secret}@@\" > ~\/.ssh\/id_rsa\necho \"@@{nutanix_public_key}@@\" > ~\/.ssh\/id_rsa.pub\nchmod 600 ~\/.ssh\/id_rsa*\ncp ~\/.ssh\/id_rsa.pub ~\/.ssh\/authorized_keys\ncp ~\/.ssh\/id_rsa.pub \/tmp\/nutanix.pub\nchmod 644 \/tmp\/nutanix.pub\n\nsudo adduser --system --shell \/bin\/bash --group --disabled-password --home \/home\/git git\nsudo su -c 'mkdir ~\/bin; chmod 750 ~\/bin' - git\nsudo su -c 'echo \"PATH=$PATH:~\/bin\" >> ~\/.profile' - git\nsudo su -c 'git clone https:\/\/github.com\/sitaramc\/gitolite' - git\nsudo su -c 'gitolite\/install -ln' - git\nsudo su -c 'gitolite setup -pk \/tmp\/nutanix.pub' - git\nrm \/tmp\/nutanix.pub\ngit clone git@@@{address}@@:gitolite-admin.git\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"a89a99a1_runbook","main_task_local_reference":{"kind":"app_task","name":"c8a23c68_dag"},"variable_list":[]},"name":"Gitolite Installation"},{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Gitolite"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Configure Demo Project"}],"name":"721b691f_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Gitolite"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Configure Demo Project","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"45466435_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"46a5a223_runbook","main_task_local_reference":{"kind":"app_task","name":"721b691f_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Gitolite"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"629e64e1_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"b5d382ab_runbook","main_task_local_reference":{"kind":"app_task","name":"629e64e1_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Gitolite"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"a8bbd555_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"ff208061_runbook","main_task_local_reference":{"kind":"app_task","name":"a8bbd555_dag"},"variable_list":[]},"name":"action_restart"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Gitolite"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"f318fc86_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"1f3c5465_runbook","main_task_local_reference":{"kind":"app_task","name":"f318fc86_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Gitolite"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"343c4dea_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"35a13bd5_runbook","main_task_local_reference":{"kind":"app_task","name":"343c4dea_dag"},"variable_list":[]},"name":"action_stop"}],"depends_on_list":[],"name":"Gitolite","port_list":[],"tier":"","variable_list":[],"description":""},{"singleton":false,"action_list":[{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Setup SSH"}],"name":"0c7134af_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Setup SSH","attrs":{"exit_status":[],"script":"mkdir ~\/.ssh\nchmod 700 ~\/.ssh\necho 'StrictHostKeyChecking no' > ~\/.ssh\/config\n\necho \"Create SSH Keys\"\necho \"@@{Nutanix Key.secret}@@\" > ~\/.ssh\/id_rsa\necho \"@@{nutanix_public_key}@@\" > ~\/.ssh\/id_rsa.pub\nchmod 600 ~\/.ssh\/id_rsa*\ncp ~\/.ssh\/id_rsa.pub  ~\/.ssh\/authorized_keys\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"7ea304d1_runbook","main_task_local_reference":{"kind":"app_task","name":"0c7134af_dag"},"variable_list":[]},"name":"Configure Base User"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Get Initial Authorization Password"},{"kind":"app_task","name":"Install Jenkins CLI"},{"kind":"app_task","name":"Install Plugins"},{"kind":"app_task","name":"Create Jenkins Credential"},{"kind":"app_task","name":"Create Prism Central Credential"}],"name":"d917d896_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Create Jenkins Credential"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Create Prism Central Credential"}},{"from_task_reference":{"kind":"app_task","name":"Get Initial Authorization Password"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Install Jenkins CLI"}},{"from_task_reference":{"kind":"app_task","name":"Install Jenkins CLI"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Install Plugins"}},{"from_task_reference":{"kind":"app_task","name":"Install Plugins"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Create Jenkins Credential"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Get Initial Authorization Password","attrs":{"exit_status":[],"script":"echo \"-------------------------\"\necho \"\"\necho \"Initial Authorization Password:\"\necho $(sudo cat \/var\/lib\/jenkins\/secrets\/initialAdminPassword)\necho \"\"\necho \"-------------------------\"\necho \"jenkins_authorization=\"$(sudo cat \/var\/lib\/jenkins\/secrets\/initialAdminPassword)\necho \"\"\n","eval_variables":["jenkins_authorization"],"eval_scope":"local","script_type":"sh","type":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Install Jenkins CLI","attrs":{"exit_status":[],"script":"echo \"Install Jenkins CLI\"\nsudo wget http:\/\/@@{address}@@:8080\/jnlpJars\/jenkins-cli.jar\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Install Plugins","attrs":{"exit_status":[],"script":"#!\/bin\/bash\nset -x\n\necho \"Install Jenkins Plugins\"\necho \"http:\/\/@@{address}@@:8080\"\necho \"admin:@@{jenkins_authorization}@@\"\n\nwget -O \/tmp\/pam-auth.hpi http:\/\/updates.jenkins-ci.org\/download\/plugins\/pam-auth\/1.4\/pam-auth.hpi\nsudo java -jar jenkins-cli.jar -auth admin:@@{jenkins_authorization}@@ -s http:\/\/@@{address}@@:8080 install-plugin -deploy file:\/\/\/tmp\/pam-auth.hpi -restart\n\nwhile true ; do\n  #sudo java -jar jenkins-cli.jar -auth admin:@@{jenkins_authorization}@@ -s http:\/\/@@{address}@@:8080 install-plugin -deploy authentication-tokens script-security bouncycastle-api http_request jackson2-api jquery-detached jsch ldap mapdb-api momentjs pam-auth nutanix-calm credentials plain-credentials resource-disposer scm-api ssh-credentials ssh-slaves structs subversion timestamper token-macro workflow-api workflow-basic-steps workflow-cps workflow-durable-task-step workflow-job workflow-multibranch workflow-scm-step workflow-step-api workflow-support workflow-aggregator credentials-binding git git-client git-server swarm cloudbees-folder cloudbees-credentials -restart\n  sudo java -jar jenkins-cli.jar -auth admin:@@{jenkins_authorization}@@ -s http:\/\/@@{address}@@:8080 install-plugin -deploy authentication-tokens script-security bouncycastle-api http_request jackson2-api jquery-detached jsch ldap mapdb-api momentjs nutanix-calm credentials plain-credentials resource-disposer scm-api ssh-credentials ssh-slaves structs subversion timestamper token-macro workflow-api workflow-basic-steps workflow-cps workflow-durable-task-step workflow-job workflow-multibranch workflow-scm-step workflow-step-api workflow-support workflow-aggregator credentials-binding git git-client git-server swarm cloudbees-folder cloudbees-credentials -restart\n  if [ $? -eq 0 ]; then\n    break\n  else\n    sleep 60\n  fi\ndone\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Create Jenkins Credential","attrs":{"exit_status":[],"script":"echo 'Wait for Jenkins Instance Restart'\nsleep 60\n\necho 'Create Jenkins Credential'\nJENKINS_SSH_KEY=$(sudo cat \/var\/lib\/jenkins\/.ssh\/id_rsa)\n\necho '<com.cloudbees.jenkins.plugins.sshcredentials.impl.BasicSSHUserPrivateKey plugin=\"ssh-credentials@1.13\">\n  <scope>GLOBAL<\/scope>\n  <id>Jenkins<\/id>\n  <description><\/description>\n  <username>jenkins<\/username>\n  <privateKeySource class=\"com.cloudbees.jenkins.plugins.sshcredentials.impl.BasicSSHUserPrivateKey$DirectEntryPrivateKeySource\">\n    <privateKey>@@{Nutanix Key.secret}@@<\/privateKey>\n  <\/privateKeySource>\n<\/com.cloudbees.jenkins.plugins.sshcredentials.impl.BasicSSHUserPrivateKey>' | sudo java -jar jenkins-cli.jar -auth admin:@@{jenkins_authorization}@@ -s http:\/\/@@{address}@@:8080 create-credentials-by-xml system::system::jenkins _\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Create Prism Central Credential","attrs":{"exit_status":[],"script":"echo \"Creating Prism Central User credential\"\necho '<com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl>\n  <scope>GLOBAL<\/scope>\n  <id>PC-User<\/id>\n  <description>Prism Central User<\/description>\n  <username>@@{Prism Central User.username}@@<\/username>\n  <password>@@{Prism Central User.secret}@@<\/password>\n<\/com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl>' | sudo java -jar \/home\/nutanix\/jenkins-cli.jar -auth admin:@@{jenkins_authorization}@@ -s http:\/\/@@{address}@@:8080 create-credentials-by-xml system::system::jenkins _ \n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"4709f4a9_runbook","main_task_local_reference":{"kind":"app_task","name":"d917d896_dag"},"variable_list":[]},"name":"Configure Jenkins Master"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Create Hook"}],"name":"660dda49_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Create Hook","attrs":{"exit_status":[],"script":"echo 'StrictHostKeyChecking no' > ~\/.ssh\/config\necho \"Create Hook\"\nssh @@{Gitolite.address}@@ 'printf \"#!\/bin\/bash\\n\/usr\/bin\/curl --user admin:@@{jenkins_authorization}@@ -s http:\/\/@@{address}@@:8080\/job\/@@{initial_project_name}@@\/buildWithParameters?token=ThisIsTheAPITokenToUse\\n\" | sudo su -c \"tee ~\/repositories\/@@{initial_project_name}@@.git\/hooks\/post-receive\" - git'\nssh @@{Gitolite.address}@@ 'sudo su -c \"chmod 775 ~\/repositories\/@@{initial_project_name}@@.git\/hooks\/post-receive\" - git'\necho \"Complete Hook\"","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"6f9a7f95_runbook","main_task_local_reference":{"kind":"app_task","name":"660dda49_dag"},"variable_list":[]},"name":"Create Git Hook"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Get APP Blueprint and Profile UUID"}],"name":"44ac4cf6_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Get APP Blueprint and Profile UUID","attrs":{"exit_status":[],"script":"user = \"@@{Prism Central User.username}@@\"\npassword = \"@@{Prism Central User.secret}@@\"\npcip = \"@@{pc_instance_ip}@@\"\n\ndef process_request(url, method, user, password, headers, payload=None):\n    r = urlreq(url, verb=method, auth=\"BASIC\", user=user, passwd=password, params=payload, verify=False, headers=headers)\n    return r\n\nurl = \"https:\/\/\" + pcip + \":9440\/api\/nutanix\/v3\/blueprints\/list\"\nheaders = {'Accept': 'application\/json', 'Content-Type': 'application\/json'}\nurl_method = \"POST\"\npayload = {\"filter\": \"name==@@{initial_app_deploy_blueprint}@@\"}\nr = process_request(url, url_method, user, password, headers, json.dumps(payload))\nprint \"Response Status: \" + str(r.status_code)\nprint \"Response: \", r.json()\napp_deploy_blueprint_uuid = r.json()['entities'][0]['status']['uuid']\nprint \"App Blueprint UUID: \" + app_deploy_blueprint_uuid\n\n#bp_uuid = ''\n#for entity in r.json()['entities']:\n#    if entity['status']['name'] == \"@@{initial_app_deploy_blueprint}@@\":\n#        bp_uuid = entity['status']['uuid']\n\nurl_method = 'GET'\nurl = \"https:\/\/\" + pcip + \":9440\/api\/nutanix\/v3\/blueprints\/\" + app_deploy_blueprint_uuid\nr = process_request(url, url_method, user, password, headers, payload)\nprint \"Response Status: \" + str(r.status_code)\nfor profile in r.json()['spec']['resources']['app_profile_list']:\n    if profile['name'] == 'Default':\n        app_profile_uuid = profile['uuid']\n       \nprint \"App Profile UUID: \" + app_profile_uuid\n\nprint \"app_deploy_blueprint_uuid=\", app_deploy_blueprint_uuid\nprint \"app_profile_uuid=\", app_profile_uuid\n","eval_variables":["app_deploy_blueprint_uuid","app_profile_uuid"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]}],"description":"","name":"d2950798_runbook","main_task_local_reference":{"kind":"app_task","name":"44ac4cf6_dag"},"variable_list":[]},"name":"Get Blueprint Details"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Create Initial Config"}],"name":"5e34fed4_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Create Initial Config","attrs":{"exit_status":[],"script":"echo 'Update Jenkins Configuration'\nsudo su -c \"sed -i 's\/<installStateName>NEW<\/<installStateName>RUNNING<\/' ~\/config.xml\" - jenkins\nsudo su -c \"sed -i 's\/numExecutors>2<\/numExecutors>0<\/' ~\/config.xml\" - jenkins\n\necho 'Create Location Configuration'\nprintf \"<?xml version='1.1' encoding='UTF-8'?>\n<jenkins.model.JenkinsLocationConfiguration>\n  <jenkinsUrl>http:\/\/@@{address}@@:8080\/<\/jenkinsUrl>\n<\/jenkins.model.JenkinsLocationConfiguration>\" | sudo su -c 'tee ~\/jenkins.model.JenkinsLocationConfiguration.xml' - jenkins\n\necho 'Set State and Version Configurations'\nsudo cat \/var\/lib\/jenkins.install.UpgradeWizard.state | sudo su -c 'tee ~\/jenkins.install.InstallUtil.lastExecVersion' - jenkins\n\necho 'Configure SSH'\nprintf \"<?xml version='1.1' encoding='UTF-8'?>\n<org.jenkinsci.main.modules.sshd.SSHD>\n  <port>22<\/port>\n<\/org.jenkinsci.main.modules.sshd.SSHD>\" | sudo su -c 'tee ~\/org.jenkinsci.main.modules.sshd.SSHD.xml' - jenkins\n\necho 'Create @@{initial_project_name}@@ Pipeline'\nsudo su -c 'mkdir -p ~\/jobs\/@@{initial_project_name}@@\/builds' - jenkins\nsudo su -c 'touch ~\/jobs\/@@{initial_project_name}@@\/builds\/legacyIds' - jenkins\nsudo su -c 'echo 1 > ~\/jobs\/@@{initial_project_name}@@\/nextBuildNumber' - jenkins\n\necho '<?xml version=\"1.1\" encoding=\"UTF-8\"?>\n<flow-definition plugin=\"workflow-job@2.23\">\n  <actions\/>\n  <description><\/description>\n  <keepDependencies>false<\/keepDependencies>\n  <properties>\n    <hudson.model.ParametersDefinitionProperty>\n      <parameterDefinitions>\n        <hudson.model.StringParameterDefinition>\n          <name>DOCKER_REGISTRY_USER<\/name>\n          <description><\/description>\n          <defaultValue>@@{Docker Registry Credential.username}@@<\/defaultValue>\n          <trim>false<\/trim>\n        <\/hudson.model.StringParameterDefinition>\n        <hudson.model.PasswordParameterDefinition>\n          <name>DOCKER_REGISTRY_PASSWORD<\/name>\n          <description><\/description>\n          <defaultValue>@@{Docker Registry Credential.secret}@@<\/defaultValue>\n        <\/hudson.model.PasswordParameterDefinition>\n        <hudson.model.StringParameterDefinition>\n          <name>DOCKER_REGISTRY<\/name>\n          <description><\/description>\n          <defaultValue>@@{Docker Registry.name}@@.@@{domain_name}@@<\/defaultValue>\n          <trim>false<\/trim>\n        <\/hudson.model.StringParameterDefinition>\n        <hudson.model.StringParameterDefinition>\n          <name>REPO_NAME<\/name>\n          <description><\/description>\n          <defaultValue>@@{initial_project_name}@@<\/defaultValue>\n          <trim>false<\/trim>\n        <\/hudson.model.StringParameterDefinition>\n      <\/parameterDefinitions>\n    <\/hudson.model.ParametersDefinitionProperty>\n  <\/properties>\n  <definition class=\"org.jenkinsci.plugins.workflow.cps.CpsScmFlowDefinition\" plugin=\"workflow-cps@2.54\">\n    <scm class=\"hudson.plugins.git.GitSCM\" plugin=\"git@3.9.1\">\n      <configVersion>2<\/configVersion>\n      <userRemoteConfigs>\n        <hudson.plugins.git.UserRemoteConfig>\n          <url>git@@@{Gitolite.name}@@.@@{domain_name}@@:@@{initial_project_name}@@.git<\/url>\n          <credentialsId>Jenkins<\/credentialsId>\n        <\/hudson.plugins.git.UserRemoteConfig>\n      <\/userRemoteConfigs>\n      <branches>\n        <hudson.plugins.git.BranchSpec>\n          <name>*\/master<\/name>\n        <\/hudson.plugins.git.BranchSpec>\n      <\/branches>\n      <doGenerateSubmoduleConfigurations>false<\/doGenerateSubmoduleConfigurations>\n      <submoduleCfg class=\"list\"\/>\n      <extensions\/>\n    <\/scm>\n    <scriptPath>Jenkinsfile<\/scriptPath>\n    <lightweight>true<\/lightweight>\n  <\/definition>\n  <triggers\/>\n  <authToken>ThisIsTheAPITokenToUse<\/authToken>\n  <disabled>false<\/disabled>\n<\/flow-definition>' | sudo su -c 'tee ~\/jobs\/@@{initial_project_name}@@\/config.xml' - jenkins\n\nsudo su -c 'chmod 644 ~\/jobs\/@@{initial_project_name}@@\/config.xml' - jenkins\nsudo su -c 'chmod 644 ~\/jobs\/@@{initial_project_name}@@\/nextBuildNumber' - jenkins\nsudo su -c 'chmod 644 ~\/jobs\/@@{initial_project_name}@@\/builds\/legacyIds' - jenkins\n\necho 'Setup Script Approvals'\necho '<?xml version=\"1.1\" encoding=\"UTF-8\"?>\n<scriptApproval plugin=\"script-security@1.44\">\n  <approvedScriptHashes\/>\n  <approvedSignatures>\n    <string>method groovy.json.JsonSlurperClassic parseText java.lang.String<\/string>\n    <string>method java.util.Map remove java.lang.Object<\/string>\n    <string>new groovy.json.JsonSlurperClassic<\/string>\n    <string>new java.util.HashMap java.util.Map<\/string>\n  <\/approvedSignatures>\n  <aclApprovedSignatures\/>\n  <approvedClasspathEntries\/>\n  <pendingScripts\/>\n  <pendingSignatures\/>\n  <pendingClasspathEntries\/>\n<\/scriptApproval>' | sudo su -c 'tee ~\/scriptApproval.xml' - jenkins\n\necho \"Create @@{initial_project_name}@@ App Deploy Job\"\nsudo su -c 'mkdir -p ~\/jobs\/@@{initial_project_name}@@_deploy\/builds' - jenkins\nsudo su -c 'touch ~\/jobs\/@@{initial_project_name}@@_deploy\/builds\/legacyIds' - jenkins\nsudo su -c 'echo 1 > ~\/jobs\/@@{initial_project_name}@@_deploy\/nextBuildNumber' - jenkins\necho '<?xml version=\"1.1\" encoding=\"UTF-8\"?>\n<flow-definition plugin=\"workflow-job@2.23\">\n  <actions\/>\n  <description><\/description>\n  <keepDependencies>false<\/keepDependencies>\n  <properties>\n    <hudson.model.ParametersDefinitionProperty>\n      <parameterDefinitions>\n        <hudson.model.StringParameterDefinition>\n          <name>ARTIFACTORY_IP<\/name>\n          <description><\/description>\n          <defaultValue>@@{Artifactory.address}@@<\/defaultValue>\n          <trim>false<\/trim>\n        <\/hudson.model.StringParameterDefinition>\n        <hudson.model.StringParameterDefinition>\n          <name>REPO_NAME<\/name>\n          <description><\/description>\n          <defaultValue><\/defaultValue>\n          <trim>false<\/trim>\n        <\/hudson.model.StringParameterDefinition>\n        <hudson.model.StringParameterDefinition>\n          <name>BUILD_NUMBER<\/name>\n          <description><\/description>\n          <defaultValue><\/defaultValue>\n          <trim>false<\/trim>\n        <\/hudson.model.StringParameterDefinition>\n      <\/parameterDefinitions>\n    <\/hudson.model.ParametersDefinitionProperty>\n  <\/properties>\n  <definition class=\"org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition\" plugin=\"workflow-cps@2.54\">\n    <script>import groovy.json.JsonSlurperClassic\nimport groovy.json.JsonOutput\n\nnode() {\n    stage(&apos;Deploy Application Via Calm&apos;){\n        echo &quot;Application deployment visual&quot;\n    }\n}\n\ndef response = httpRequest authentication: &apos;PC-User&apos;, consoleLogResponseBody: false, customHeaders: [[maskValue: false, name: &apos;Content-Type&apos;, value: &apos;application\/json&apos;]], ignoreSslErrors: true, responseHandle: &apos;LEAVE_OPEN&apos;, url: &apos;https:\/\/@@{pc_instance_ip}@@:9440\/api\/nutanix\/v3\/blueprints\/@@{app_deploy_blueprint_uuid}@@&apos;\n\nprintln(&quot;Status: &quot; + response.status)\n\/\/println(&quot;Content: &quot; + response.content)\n\ndef blueprint_spec = parseJSON(response.content)\ndef bp_index = 0\ndef var_index = 0\nblueprint_spec.remove(&apos;status&apos;)\nblueprint_spec[&apos;spec&apos;].remove(&apos;name&apos;)\nblueprint_spec[&apos;spec&apos;][&apos;application_name&apos;] = REPO_NAME + &apos;@@{calm_random}@@Jenkins&apos; + BUILD_NUMBER.toString()\nblueprint_spec[&apos;spec&apos;][&apos;app_profile_reference&apos;] = parseJSON(&apos;{&quot;kind&quot;: &quot;app_profile&quot;, &quot;uuid&quot;: &quot;@@{app_profile_uuid}@@&quot;}&apos;)\nblueprint_spec[&apos;metadata&apos;][&apos;owner_reference&apos;] = parseJSON(&apos;{&quot;kind&quot;: &quot;user&quot;, &quot;uuid&quot;: &quot;00000000-0000-0000-0000-000000000000&quot;, &quot;name&quot;: &quot;admin&quot;}&apos;)\nblueprint_spec[&apos;spec&apos;][&apos;resources&apos;][&apos;app_profile_list&apos;].each  { profileKey, profileRow -&gt; \n    println(&quot;Profile: ${profileKey}&quot;); \n    profileKey[&apos;variable_list&apos;].each { variableKey, variableRow -&gt;\n        println(&quot;Variable: ${variableKey}&quot;); \n        if (variableKey[&apos;name&apos;] == &apos;build_number&apos;){\n                blueprint_spec[&apos;spec&apos;][&apos;resources&apos;][&apos;app_profile_list&apos;][bp_index][&apos;variable_list&apos;][var_index][&apos;value&apos;] = BUILD_NUMBER.toString()\n        } else if (variableKey[&apos;name&apos;] == &apos;project_name&apos;){\n                blueprint_spec[&apos;spec&apos;][&apos;resources&apos;][&apos;app_profile_list&apos;][bp_index][&apos;variable_list&apos;][var_index][&apos;value&apos;] = REPO_NAME\n        } else if (variableKey[&apos;name&apos;] == &apos;artifactory_ip&apos;){\n                blueprint_spec[&apos;spec&apos;][&apos;resources&apos;][&apos;app_profile_list&apos;][bp_index][&apos;variable_list&apos;][var_index][&apos;value&apos;] = ARTIFACTORY_IP\n        }\n        var_index += 1;\n    }; \n    bp_index += 1;\n}\n\/\/println(&quot;Content: &quot; + blueprint_spec)\n\ndef payload = JsonOutput.toJson(blueprint_spec)\nprintln(&quot;Payload: &quot; + payload)\n\ndef result = httpRequest authentication: &apos;PC-User&apos;, consoleLogResponseBody: true, customHeaders: [[maskValue: false, name: &apos;Content-Type&apos;, value: &apos;application\/json&apos;], [maskValue: false, name: &apos;Accept&apos;, value: &apos;application\/json&apos;]], httpMode: &apos;POST&apos;, requestBody: payload, ignoreSslErrors: true, responseHandle: &apos;LEAVE_OPEN&apos;, url: &apos;https:\/\/@@{pc_instance_ip}@@:9440\/api\/nutanix\/v3\/blueprints\/@@{app_deploy_blueprint_uuid}@@\/launch&apos;\nprintln(&quot;Status: &quot; + response.status)\nprintln(&quot;Content: &quot; + response.content)\n\ndef parseJSON(json) {\n    return new groovy.json.JsonSlurperClassic().parseText(json)\n}\n<\/script>\n    <sandbox>true<\/sandbox>\n  <\/definition>\n  <triggers\/>\n  <disabled>false<\/disabled>\n<\/flow-definition>'  | sudo su -c 'tee ~\/jobs\/@@{initial_project_name}@@_deploy\/config.xml' - jenkins\n\nsudo su -c 'chmod 644 ~\/jobs\/@@{initial_project_name}@@_deploy\/config.xml' - jenkins\nsudo su -c 'chmod 644 ~\/jobs\/@@{initial_project_name}@@_deploy\/nextBuildNumber' - jenkins\nsudo su -c 'chmod 644 ~\/jobs\/@@{initial_project_name}@@_deploy\/builds\/legacyIds' - jenkins\n\necho \"@@{Docker Registry.address}@@ @@{Docker Registry.name}@@.@@{domain_name}@@ @@{Docker Registry.name}@@\" | sudo tee -a \/etc\/hosts\necho \"@@{Gitolite.address}@@ @@{Gitolite.name}@@.@@{domain_name}@@ @@{Gitolite.name}@@\" | sudo tee -a \/etc\/hosts\necho \"@@{Artifactory.address}@@ artifactory.@@{domain_name}@@ artifactory\" | sudo tee -a \/etc\/hosts\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"a7f09fc6_runbook","main_task_local_reference":{"kind":"app_task","name":"5e34fed4_dag"},"variable_list":[]},"name":"Initial Jenkins Config"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Install Jenkins Master"}],"name":"f813c237_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Install Jenkins Master","attrs":{"exit_status":[],"script":"set -x\nwget -q -O - https:\/\/pkg.jenkins.io\/debian\/jenkins-ci.org.key | sudo apt-key add -\necho deb https:\/\/pkg.jenkins.io\/debian-stable binary\/ | sudo tee \/etc\/apt\/sources.list.d\/jenkins.list\nsudo apt-get update\nsudo apt-get install python2.7 -y\nsudo apt-get install default-jre -y\nsudo apt-get install jenkins -y\nsudo apt-get install wget -y\nsudo ufw allow 8080\nsudo ufw allow ssh\nsudo ufw status\necho \"alias python=python2.7\" >> ~\/.bashrc\nsudo ln -s \/usr\/bin\/python2.7 \/usr\/bin\/python\n\nexit 0\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"4fa5acdd_runbook","main_task_local_reference":{"kind":"app_task","name":"f813c237_dag"},"variable_list":[]},"name":"Jenkins Master Installation"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Setup SSH Jenkins User"}],"name":"2a7f764b_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Setup SSH Jenkins User","attrs":{"exit_status":[],"script":"echo \"Create SSH Keys\"\nsudo su -c 'mkdir ~\/.ssh' - jenkins\nsudo su -c 'chmod 700 ~\/.ssh' - jenkins\nsudo su -c 'echo \"@@{Jenkins Key.secret}@@\" > ~\/.ssh\/id_rsa' - jenkins\nsudo su -c 'echo \"@@{jenkins_public_key}@@\" > ~\/.ssh\/id_rsa.pub' - jenkins\nsudo su -c 'chmod 600 ~\/.ssh\/id_rsa*' - jenkins\nsudo su -c 'echo \"set -o vi\" > ~\/.bashrc' - jenkins\nsudo su -c 'echo \"StrictHostKeyChecking no\" > ~\/.ssh\/config' - jenkins\n\necho \"\"\necho \"Get Public Key\"\necho \"jenkins_ssh_key_pub=\"$(sudo cat \/var\/lib\/jenkins\/.ssh\/id_rsa.pub)\n","eval_variables":["jenkins_ssh_key_pub"],"eval_scope":"local","script_type":"sh","type":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]}],"description":"","name":"824881bb_runbook","main_task_local_reference":{"kind":"app_task","name":"2a7f764b_dag"},"variable_list":[]},"name":"Jenkins User Config"},{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Master"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Jenkins User Config"},{"kind":"app_task","name":"Initial Jenkins Config"},{"kind":"app_task","name":"Configure Jenkins Master"},{"kind":"app_task","name":"Create Git Hook"}],"name":"1e33d0f4_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Configure Jenkins Master"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Create Git Hook"}},{"from_task_reference":{"kind":"app_task","name":"Initial Jenkins Config"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Configure Jenkins Master"}},{"from_task_reference":{"kind":"app_task","name":"Jenkins User Config"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Initial Jenkins Config"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Jenkins User Config","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"824881bb_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Initial Jenkins Config","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"a7f09fc6_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Configure Jenkins Master","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"4709f4a9_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Create Git Hook","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"6f9a7f95_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"e3fc86ab_runbook","main_task_local_reference":{"kind":"app_task","name":"1e33d0f4_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"2d5a6005_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"a8778ba5_runbook","main_task_local_reference":{"kind":"app_task","name":"2d5a6005_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"ee069ba2_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"47d11a43_runbook","main_task_local_reference":{"kind":"app_task","name":"ee069ba2_dag"},"variable_list":[]},"name":"action_restart"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"c4c94a95_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"d051fa61_runbook","main_task_local_reference":{"kind":"app_task","name":"c4c94a95_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"1a27c33e_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"9df54ae2_runbook","main_task_local_reference":{"kind":"app_task","name":"1a27c33e_dag"},"variable_list":[]},"name":"action_stop"}],"depends_on_list":[{"kind":"app_service","name":"Artifactory"},{"kind":"app_service","name":"Docker Registry"},{"kind":"app_service","name":"Gitolite"}],"name":"Jenkins Master","port_list":[],"tier":"","variable_list":[{"val_type":"STRING","description":"","name":"app_deploy_blueprint_uuid","type":"LOCAL","value":"","label":"","attrs":{"type":""}},{"val_type":"STRING","description":"","name":"app_profile_uuid","type":"LOCAL","value":"","label":"","attrs":{"type":""}},{"val_type":"STRING","description":"","name":"jenkins_authorization","type":"LOCAL","value":"","label":"","attrs":{"type":""}},{"val_type":"STRING","description":"","name":"jenkins_ssh_key_pub","type":"LOCAL","value":"","label":"","attrs":{"type":""}}],"description":""},{"singleton":false,"action_list":[{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Load Cert"}],"name":"105113e0_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Slave"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Load Cert","attrs":{"exit_status":[],"script":"set -x\n\nmkdir ~\/.ssh\nchmod 700 ~\/.ssh\necho @@{Nutanix Key.secret}@@ #> ~\/.ssh\/id_rsa\nchmod 600 ~\/.ssh\/id_rsa\necho @@{nutanix_public_key}@@ #> ~\/.ssh\/id_rsa.pub\nchmod 600 ~\/.ssh\/id_rsa.pub\nsudo mkdir \/usr\/local\/share\/ca-certificates\/docker-dev-cert\nREGISTRY_IP=@@{Docker Registry.address}@@\nsshpass -p @@{Ubuntu Credential.secret}@@ scp -oStrictHostKeyChecking=no ${REGISTRY_IP}:~\/devdockerCA.crt \/tmp\nsudo mv \/tmp\/devdockerCA.crt \/usr\/local\/share\/ca-certificates\/docker-dev-cert\/devdockerCA.crt\nsudo update-ca-certificates\nsudo service docker restart\necho \"@@{Docker Registry.address}@@ @@{Docker Registry.name}@@.@@{domain_name}@@ @@{Docker Registry.name}@@\" | sudo tee -a \/etc\/hosts\necho \"@@{Gitolite.address}@@ @@{Gitolite.name}@@.@@{domain_name}@@ @@{Gitolite.name}@@\" | sudo tee -a \/etc\/hosts\necho \"@@{Artifactory.address}@@ artifactory.@@{domain_name}@@ artifactory\" | sudo tee -a \/etc\/hosts\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"f8bc367a_runbook","main_task_local_reference":{"kind":"app_task","name":"105113e0_dag"},"variable_list":[]},"name":"Configure Connectivity"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Install Jenkins CLI"},{"kind":"app_task","name":"Configure Jenkins Slave"}],"name":"19e541c4_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Install Jenkins CLI"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Configure Jenkins Slave"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Slave"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Install Jenkins CLI","attrs":{"exit_status":[],"script":"#Download jenkins-cli\nsudo apt-get -y install wget\n\nsleep 30\n\nsudo wget http:\/\/@@{Jenkins Master.address}@@:8080\/jnlpJars\/jenkins-cli.jar\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Slave"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Configure Jenkins Slave","attrs":{"exit_status":[],"script":"JENKINS_URL=http:\/\/@@{Jenkins Master.address}@@:8080\nNODE_NAME=@@{name}@@\nNODE_IP=@@{address}@@\nNODE_SLAVE_HOME='\/home\/nutanix'\nEXECUTORS=1\nSSH_PORT=22\nCRED_ID=Jenkins-Slave\nLABELS=build\nUSERID=admin\n\necho \"Creating credential\"\necho '<com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl>\n  <scope>GLOBAL<\/scope>\n  <id>Jenkins-Slave<\/id>\n  <description>Slave Login<\/description>\n  <username>@@{Ubuntu Credential.username}@@<\/username>\n  <password>@@{Ubuntu Credential.secret}@@<\/password>\n<\/com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl>' | sudo java -jar \/home\/nutanix\/jenkins-cli.jar -auth admin:@@{Jenkins Master.jenkins_authorization}@@ -s http:\/\/@@{Jenkins Master.address}@@:8080  create-credentials-by-xml system::system::jenkins _ \n\necho \"Creating slave node\"\ncat <<EOF | sudo java -jar ${NODE_SLAVE_HOME}\/jenkins-cli.jar -auth admin:@@{Jenkins Master.jenkins_authorization}@@ -s ${JENKINS_URL} create-node ${NODE_NAME}\n<slave>\n  <name>${NODE_NAME}<\/name>\n  <description>Jenkins Slave Node<\/description>\n  <remoteFS>${NODE_SLAVE_HOME}<\/remoteFS>\n  <numExecutors>${EXECUTORS}<\/numExecutors>\n  <mode>NORMAL<\/mode>\n  <launcher class=\"hudson.plugins.sshslaves.SSHLauncher\" plugin=\"ssh-slaves\">\n    <host>${NODE_IP}<\/host>\n    <port>${SSH_PORT}<\/port>\n    <credentialsId>${CRED_ID}<\/credentialsId>\n    <maxNumRetries>0<\/maxNumRetries>\n    <retryWaitTime>0<\/retryWaitTime>\n    <sshHostKeyVerificationStrategy class=\"hudson.plugins.sshslaves.verifiers.NonVerifyingKeyVerificationStrategy\"\/>\n  <\/launcher>\n  <label>${LABELS}<\/label>\n  <nodeProperties\/>\n<\/slave>\nEOF","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"6d2cd303_runbook","main_task_local_reference":{"kind":"app_task","name":"19e541c4_dag"},"variable_list":[]},"name":"Configure Jenkins Slave"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Install Docker"},{"kind":"app_task","name":"Install Docker Compose"}],"name":"8f42cde8_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Install Docker"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Install Docker Compose"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Slave"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Install Docker","attrs":{"exit_status":[],"script":"echo \"** Downloading Docker Repo Key...\"\ncurl -fsSL https:\/\/download.docker.com\/linux\/ubuntu\/gpg | sudo apt-key add -\n\necho \"** Adding Docker Repo...\"\nsudo add-apt-repository \"deb [arch=amd64] https:\/\/download.docker.com\/linux\/ubuntu $(lsb_release -cs) stable\"\n\necho \"** Apt Update...\"\nsudo apt-get update\nsudo apt-get install -y sshpass\n\necho \"** Set apt-cache policy for docker-ce...\"\napt-cache policy docker-ce\n\necho \"** Installing Docker CE...\"\nsudo apt-get install -y docker-ce\n\necho \"** Adding current user to docker group...\"\nsudo usermod -aG docker @@{Ubuntu Credential.username}@@\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Slave"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Install Docker Compose","attrs":{"exit_status":[],"script":"echo \"** Installing python-pip...\"\nsudo apt-get -y install python-pip\n\necho \"** Upgrade pip...\"\nsudo pip install --upgrade pip\n\necho \"** Install docker-compose...\"\nsudo pip install docker-compose","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"eb6bcfac_runbook","main_task_local_reference":{"kind":"app_task","name":"8f42cde8_dag"},"variable_list":[]},"name":"Docker Installation"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Install Java"}],"name":"20cf7e99_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Slave"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Install Java","attrs":{"exit_status":[],"script":"sudo apt-get install default-jre -y\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"c8435ece_runbook","main_task_local_reference":{"kind":"app_task","name":"20cf7e99_dag"},"variable_list":[]},"name":"Java Installation"},{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Slave"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Configure Connectivity"},{"kind":"app_task","name":"Configure Jenkins Slave"}],"name":"ae5e6af0_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Configure Connectivity"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Configure Jenkins Slave"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Slave"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Configure Connectivity","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"f8bc367a_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Slave"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Configure Jenkins Slave","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"6d2cd303_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"af3d1fe3_runbook","main_task_local_reference":{"kind":"app_task","name":"ae5e6af0_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Slave"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"e92443c7_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"555be4c9_runbook","main_task_local_reference":{"kind":"app_task","name":"e92443c7_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Slave"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"00c19b6d_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"04de4a48_runbook","main_task_local_reference":{"kind":"app_task","name":"00c19b6d_dag"},"variable_list":[]},"name":"action_restart"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Slave"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"117602e2_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"ccc2a1d7_runbook","main_task_local_reference":{"kind":"app_task","name":"117602e2_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Slave"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"6e79884f_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"d6f485c8_runbook","main_task_local_reference":{"kind":"app_task","name":"6e79884f_dag"},"variable_list":[]},"name":"action_stop"}],"depends_on_list":[{"kind":"app_service","name":"Jenkins Master"}],"name":"Jenkins Slave","port_list":[],"tier":"","variable_list":[],"description":""}],"substrate_definition_list":[{"description":"","action_list":[],"type":"AHV_VM","name":"ArtifactoryVM","readiness_probe":{"connection_type":"SSH","retries":"5","disable_readiness_probe":false,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"0","connection_port":22,"login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"editables":{"create_spec":{"resources":{"nic_list":{},"serial_port_list":{},"disk_list":{}}}},"os_type":"Linux","create_spec":{"name":"artifactory-@@{calm_random}@@","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"dd1a9fed-a931-48d4-9861-4ac102da2480"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":1,"num_sockets":2,"gpu_list":[],"memory_size_mib":4096,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":{"cloud_init":{"meta_data":"","type":"","user_data":"#cloud-config\nfqdn: @@{name}@@.gso.lab\nmanage_etc_hosts: true\nhostname: @@{name}@@"},"type":"","sysprep":null},"power_state":"ON","type":"","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"image","type":"","name":"ubu-template.qcow2","uuid":"586b044d-4123-4f11-8304-ac207d9972e7"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]},{"description":"","action_list":[],"type":"AHV_VM","name":"DockerRegistryVM","readiness_probe":{"connection_type":"SSH","retries":"5","disable_readiness_probe":false,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"0","connection_port":22,"login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"editables":{"create_spec":{"resources":{"nic_list":{},"serial_port_list":{},"disk_list":{}}}},"os_type":"Linux","create_spec":{"name":"docker-registry-@@{calm_random}@@","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"dd1a9fed-a931-48d4-9861-4ac102da2480"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":1,"num_sockets":4,"gpu_list":[],"memory_size_mib":4096,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":{"cloud_init":{"meta_data":"","type":"","user_data":"#cloud-config\nfqdn: @@{name}@@.gso.lab\nmanage_etc_hosts: true\nhostname: docker-registry"},"type":"","sysprep":null},"power_state":"ON","type":"","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"image","type":"","name":"ubu-template.qcow2","uuid":"586b044d-4123-4f11-8304-ac207d9972e7"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]},{"description":"","action_list":[],"type":"AHV_VM","name":"GitoliteVM","readiness_probe":{"connection_type":"SSH","retries":"5","disable_readiness_probe":false,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"0","connection_port":22,"login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"editables":{"create_spec":{"resources":{"nic_list":{},"serial_port_list":{},"disk_list":{}}}},"os_type":"Linux","create_spec":{"name":"git-server-@@{calm_random}@@","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"dd1a9fed-a931-48d4-9861-4ac102da2480"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":1,"num_sockets":1,"gpu_list":[],"memory_size_mib":2048,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":{"cloud_init":{"meta_data":"","type":"","user_data":"#cloud-config\nfqdn: @@{name}@@.gso.lab\nmanage_etc_hosts: true\nhostname: @@{name}@@"},"type":"","sysprep":null},"power_state":"ON","type":"","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"image","type":"","name":"ubu-template.qcow2","uuid":"586b044d-4123-4f11-8304-ac207d9972e7"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]},{"description":"","action_list":[],"type":"AHV_VM","name":"JenkinsMasterVM","readiness_probe":{"connection_type":"SSH","retries":"5","disable_readiness_probe":false,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"0","connection_port":22,"login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"editables":{"create_spec":{"resources":{"nic_list":{},"serial_port_list":{},"disk_list":{}}}},"os_type":"Linux","create_spec":{"name":"jenkins-master-@@{calm_random}@@","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"dd1a9fed-a931-48d4-9861-4ac102da2480"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":1,"num_sockets":1,"gpu_list":[],"memory_size_mib":4096,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":{"cloud_init":{"meta_data":"","type":"","user_data":"#cloud-config\nfqdn: @@{name}@@.gso.lab\nmanage_etc_hosts: true\nhostname: @@{name}@@"},"type":"","sysprep":null},"power_state":"ON","type":"","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"image","type":"","name":"ubu-template.qcow2","uuid":"586b044d-4123-4f11-8304-ac207d9972e7"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]},{"description":"","action_list":[],"type":"AHV_VM","name":"JenkinsSlaveVM","readiness_probe":{"connection_type":"SSH","retries":"5","disable_readiness_probe":false,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"0","connection_port":22,"login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"editables":{"create_spec":{"resources":{"nic_list":{},"serial_port_list":{},"disk_list":{}}}},"os_type":"Linux","create_spec":{"name":"jenkins-slave-@@{calm_random}@@","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"dd1a9fed-a931-48d4-9861-4ac102da2480"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":1,"num_sockets":4,"gpu_list":[],"memory_size_mib":4096,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":{"cloud_init":{"meta_data":"","type":"","user_data":"#cloud-config\nfqdn: @@{name}@@.gso.lab\nmanage_etc_hosts: true\nhostname: @@{name}@@"},"type":"","sysprep":null},"power_state":"ON","type":"","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"image","type":"","name":"ubu-template.qcow2","uuid":"586b044d-4123-4f11-8304-ac207d9972e7"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]},{"description":"","action_list":[],"type":"AHV_VM","name":"WorkstationVM","readiness_probe":{"connection_type":"SSH","retries":"5","disable_readiness_probe":false,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"0","connection_port":22,"login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"editables":{"create_spec":{"resources":{"nic_list":{},"serial_port_list":{},"disk_list":{}}}},"os_type":"Linux","create_spec":{"name":"dev-workstation-@@{calm_random}@@","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"dd1a9fed-a931-48d4-9861-4ac102da2480"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":1,"num_sockets":1,"gpu_list":[],"memory_size_mib":4096,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":{"cloud_init":{"meta_data":"","type":"","user_data":"#cloud-config\nfqdn: @@{name}@@.gso.lab\nmanage_etc_hosts: true\nhostname: @@{name}@@"},"type":"","sysprep":null},"power_state":"ON","type":"","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"image","type":"","name":"ubu-template.qcow2","uuid":"586b044d-4123-4f11-8304-ac207d9972e7"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]}],"credential_definition_list":[{"username":"nutanix","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"Docker Registry Credential","editables":{"username":true,"secret":true}},{"username":"jenkins","description":"","type":"KEY","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"Jenkins Key","editables":{"username":true,"secret":true}},{"username":"nutanix","description":"","type":"KEY","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"Nutanix Key","editables":{"username":true,"secret":true}},{"username":"admin","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"Prism Central User","editables":{"username":true,"secret":true}},{"username":"nutanix","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"Ubuntu Credential","editables":{"username":true,"secret":true}}],"package_definition_list":[{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"Artifactory"}],"name":"ArtifactoryPackage","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"ArtifactoryPackage"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[{"kind":"app_task","name":"Docker Installation"},{"kind":"app_task","name":"Artifactory Installation"}],"name":"8e7d1b8d_dag","state":"ACTIVE","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Docker Installation"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Artifactory Installation"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Artifactory"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Docker Installation","state":"ACTIVE","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"350f897b_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Artifactory"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Artifactory Installation","state":"ACTIVE","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"af31aac3_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"71d086d7_runbook_cloned_1","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"8e7d1b8d_dag"},"message_list":[],"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"ArtifactoryPackage"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"ae0fc3d0_dag","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"3867060f_runbook_cloned_1","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"ae0fc3d0_dag"},"message_list":[],"variable_list":[]}},"variable_list":[]},{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"Docker Registry"}],"name":"Docker Registry Install","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Docker Registry Install"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[{"kind":"app_task","name":"Docker Installation"},{"kind":"app_task","name":"Docker Registry Installation"}],"name":"57ea840c_dag","state":"ACTIVE","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Docker Installation"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Docker Registry Installation"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Docker Registry"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Docker Installation","state":"ACTIVE","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"991aa9e9_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Docker Registry"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Docker Registry Installation","state":"ACTIVE","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"6a6ef171_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"6423da3d_runbook_cloned_1","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"57ea840c_dag"},"message_list":[],"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Docker Registry Install"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"e4a1d78d_dag","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"2b6f43e2_runbook_cloned_1","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"e4a1d78d_dag"},"message_list":[],"variable_list":[]}},"variable_list":[]},{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"Gitolite"}],"name":"GitolitePackage","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"GitolitePackage"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[{"kind":"app_task","name":"Gitolite Installation"}],"name":"037bb3fc_dag","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Gitolite"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Gitolite Installation","state":"ACTIVE","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"a89a99a1_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"30a62397_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"037bb3fc_dag"},"message_list":[],"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"GitolitePackage"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"29d1a79f_dag","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"e129694b_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"29d1a79f_dag"},"message_list":[],"variable_list":[]}},"variable_list":[]},{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"Jenkins Master"}],"name":"JenkinsMasterPackage","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"JenkinsMasterPackage"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[{"kind":"app_task","name":"Jenkins Master Installation"},{"kind":"app_task","name":"Configure Base User"},{"kind":"app_task","name":"Get Blueprint Details"}],"name":"116239e7_dag","state":"ACTIVE","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Configure Base User"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Get Blueprint Details"}},{"from_task_reference":{"kind":"app_task","name":"Jenkins Master Installation"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Configure Base User"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Master"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Jenkins Master Installation","state":"ACTIVE","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"4fa5acdd_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Master"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Configure Base User","state":"ACTIVE","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"7ea304d1_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Master"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Get Blueprint Details","state":"ACTIVE","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"d2950798_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"debd6783_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"116239e7_dag"},"message_list":[],"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"JenkinsMasterPackage"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"75071e5e_dag","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"784076f4_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"75071e5e_dag"},"message_list":[],"variable_list":[]}},"variable_list":[]},{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"Jenkins Slave"}],"name":"JenkinsSlave Install","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"JenkinsSlave Install"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[{"kind":"app_task","name":"Docker Installation"},{"kind":"app_task","name":"Java Installation"}],"name":"57ea840c_dag","state":"ACTIVE","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Docker Installation"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Java Installation"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Slave"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Docker Installation","state":"ACTIVE","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"eb6bcfac_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Slave"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Java Installation","state":"ACTIVE","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"c8435ece_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"6423da3d_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"57ea840c_dag"},"message_list":[],"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"JenkinsSlave Install"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"e4a1d78d_dag","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"2b6f43e2_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"e4a1d78d_dag"},"message_list":[],"variable_list":[]}},"variable_list":[]},{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"Developer Workstation"}],"name":"WorkstationPackage","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"WorkstationPackage"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[{"kind":"app_task","name":"Docker Installation"},{"kind":"app_task","name":"NodeJS Installation"}],"name":"8e7d1b8d_dag","state":"ACTIVE","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Docker Installation"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"NodeJS Installation"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Developer Workstation"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Docker Installation","state":"ACTIVE","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"4d4b18fe_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Developer Workstation"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"NodeJS Installation","state":"ACTIVE","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"ffab2e14_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"71d086d7_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"8e7d1b8d_dag"},"message_list":[],"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"WorkstationPackage"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"ae0fc3d0_dag","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"3867060f_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"ae0fc3d0_dag"},"message_list":[],"variable_list":[]}},"variable_list":[]}],"app_profile_list":[{"deployment_create_list":[{"type":"GREENFIELD","action_list":[],"depends_on_list":[],"name":"1afa7711_deployment","published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"JenkinsMasterPackage"}],"substrate_local_reference":{"kind":"app_substrate","name":"JenkinsMasterVM"},"min_replicas":"1","variable_list":[],"description":""},{"type":"GREENFIELD","action_list":[],"depends_on_list":[],"name":"8cafc62e_deployment","published_service_local_reference_list":[],"max_replicas":"5","package_local_reference_list":[{"kind":"app_package","name":"JenkinsSlave Install"}],"substrate_local_reference":{"kind":"app_substrate","name":"JenkinsSlaveVM"},"min_replicas":"2","variable_list":[],"description":""},{"type":"GREENFIELD","action_list":[],"depends_on_list":[],"name":"8cafc62e_deployment_cloned_1","published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"Docker Registry Install"}],"substrate_local_reference":{"kind":"app_substrate","name":"DockerRegistryVM"},"min_replicas":"1","variable_list":[],"description":""},{"type":"GREENFIELD","action_list":[],"depends_on_list":[],"name":"aa65c031_deployment","published_service_local_reference_list":[],"max_replicas":"10","package_local_reference_list":[{"kind":"app_package","name":"WorkstationPackage"}],"substrate_local_reference":{"kind":"app_substrate","name":"WorkstationVM"},"min_replicas":"1","variable_list":[],"description":""},{"type":"GREENFIELD","action_list":[],"depends_on_list":[],"name":"aa65c031_deployment_cloned_1","published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"ArtifactoryPackage"}],"substrate_local_reference":{"kind":"app_substrate","name":"ArtifactoryVM"},"min_replicas":"1","variable_list":[],"description":""},{"type":"GREENFIELD","action_list":[],"depends_on_list":[],"name":"fe95f237_deployment","published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"GitolitePackage"}],"substrate_local_reference":{"kind":"app_substrate","name":"GitoliteVM"},"min_replicas":"1","variable_list":[],"description":""}],"description":"","action_list":[{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Create Artifact Repository"},{"kind":"app_task","name":"Initialize Git Repository"},{"kind":"app_task","name":"Get APP Blueprint and Profile UUID"},{"kind":"app_task","name":"Configure Project Access"},{"kind":"app_task","name":"Config Jenkins Jobs"},{"kind":"app_task","name":"Initialize Workstation Git Repository"},{"kind":"app_task","name":"Restart Jenkins Service"},{"kind":"app_task","name":"Download Version 1 Demo Code"},{"kind":"app_task","name":"Wait for Restart"},{"kind":"app_task","name":"Create Git Hook"},{"kind":"app_task","name":"Create and Push Docker Images"}],"name":"efbcbb73_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Config Jenkins Jobs"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Restart Jenkins Service"}},{"from_task_reference":{"kind":"app_task","name":"Configure Project Access"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Create Git Hook"}},{"from_task_reference":{"kind":"app_task","name":"Configure Project Access"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Initialize Workstation Git Repository"}},{"from_task_reference":{"kind":"app_task","name":"Download Version 1 Demo Code"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Create and Push Docker Images"}},{"from_task_reference":{"kind":"app_task","name":"Get APP Blueprint and Profile UUID"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Config Jenkins Jobs"}},{"from_task_reference":{"kind":"app_task","name":"Initialize Git Repository"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Configure Project Access"}},{"from_task_reference":{"kind":"app_task","name":"Initialize Workstation Git Repository"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Download Version 1 Demo Code"}},{"from_task_reference":{"kind":"app_task","name":"Restart Jenkins Service"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Wait for Restart"}},{"from_task_reference":{"kind":"app_task","name":"Wait for Restart"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Create Git Hook"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Artifactory"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Create Artifact Repository","attrs":{"exit_status":[],"script":"echo \"Initialize Artifactory @@{new_project_name}@@ Repository\"\n\necho '  @@{new_project_name}@@-local-repo:\n    type: generic\n    checksumPolicyType: server-generated-checksums\n    description: \"@@{new_project_name}@@ Artifact Repository\"\n    dockerApiVersion: V2\n    excludesPattern:\n    includesPattern:\n    maxUniqueSnapshots: 0\n    maxUniqueTags: 0\n    repoLayout: simple-default\n    snapshotVersionBehavior: unique\n    blackedOut: false\n    enableFileListsIndexing: false\n    forceNugetAuthentication: false\n    handleReleases: true\n    handleSnapshots: true\n    suppressPomConsistencyChecks: true' >> ~\/artifactory-repo-config.yml\n\nsleep 3\n\ncurl -u admin:password -X PATCH \"http:\/\/localhost:8081\/artifactory\/api\/system\/configuration\" -H \u201cContent-Type:application\/yaml\u201d -T ~\/artifactory-repo-config.yml\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Gitolite"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Initialize Git Repository","attrs":{"exit_status":[],"script":"echo \"Create and Configure @@{new_project_name}@@ Repository\"\nsudo su -c 'mkdir ~\/repositories\/@@{new_project_name}@@.git' - git\nsudo su -c 'cd ~\/repositories\/@@{new_project_name}@@.git && git init --bare' - git\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Get APP Blueprint and Profile UUID","attrs":{"exit_status":[],"script":"user = \"@@{Prism Central User.username}@@\"\npassword = \"@@{Prism Central User.secret}@@\"\n\ndef process_request(url, method, user, password, headers, payload=None):\n    r = urlreq(url, verb=method, auth=\"BASIC\", user=user, passwd=password, params=payload, verify=False, headers=headers)\n    return r\n\nurl = \"https:\/\/@@{pc_instance_ip}@@:9440\/api\/nutanix\/v3\/blueprints\/list\"\nheaders = {'Accept': 'application\/json', 'Content-Type': 'application\/json'}\nurl_method = \"POST\"\npayload = {\"filter\": \"name==@@{new_app_deploy_blueprint}@@\"}\nr = process_request(url, url_method, user, password, headers, json.dumps(payload))\nprint \"Response Status: \" + str(r.status_code)\nprint \"Response: \", r.json()\napp_deploy_blueprint_uuid = r.json()['entities'][0]['status']['uuid']\nprint \"App Blueprint UUID: \" + app_deploy_blueprint_uuid\n\n#bp_uuid = ''\n#for entity in r.json()['entities']:\n#    if entity['status']['name'] == \"@@{new_app_deploy_blueprint}@@\":\n#        bp_uuid = entity['status']['uuid']\n\nurl_method = 'GET'\nurl = \"https:\/\/@@{pc_instance_ip}@@:9440\/api\/nutanix\/v3\/blueprints\/\" + app_deploy_blueprint_uuid\nr = process_request(url, url_method, user, password, headers, payload)\nprint \"Response Status: \" + str(r.status_code)\nfor profile in r.json()['spec']['resources']['app_profile_list']:\n    if profile['name'] == 'Default':\n        app_profile_uuid = profile['uuid']\n       \nprint \"App Profile UUID: \" + app_profile_uuid\n\nprint \"app_deploy_blueprint_uuid=\", app_deploy_blueprint_uuid\nprint \"app_profile_uuid=\", app_profile_uuid\n","eval_variables":["app_deploy_blueprint_uuid","app_profile_uuid"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Gitolite"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Configure Project Access","attrs":{"exit_status":[],"script":"echo \"Configure @@{new_project_name}@@ Repository Access\"\necho \"repo @@{new_project_name}@@\" >> ~\/gitolite-admin\/conf\/gitolite.conf\necho \"    RW+     =   @all\" >> ~\/gitolite-admin\/conf\/gitolite.conf \necho \"    R       =   jenkins\" >> ~\/gitolite-admin\/conf\/gitolite.conf \n\necho \"Check IN and Commit Changes\"\ncd gitolite-admin\ngit add conf\/gitolite.conf\ngit commit -m \"Added @@{new_project_name}@@ Repository\"\ngit push origin master","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Config Jenkins Jobs","attrs":{"exit_status":[],"script":"echo 'Create @@{new_project_name}@@ Pipeline'\nsudo su -c 'mkdir -p ~\/jobs\/@@{new_project_name}@@\/builds' - jenkins\nsudo su -c 'touch ~\/jobs\/@@{new_project_name}@@\/builds\/legacyIds' - jenkins\nsudo su -c 'echo 1 > ~\/jobs\/@@{new_project_name}@@\/nextBuildNumber' - jenkins\n\necho '<?xml version=\"1.1\" encoding=\"UTF-8\"?>\n<flow-definition plugin=\"workflow-job@2.23\">\n  <actions\/>\n  <description><\/description>\n  <keepDependencies>false<\/keepDependencies>\n  <properties>\n    <hudson.model.ParametersDefinitionProperty>\n      <parameterDefinitions>\n        <hudson.model.StringParameterDefinition>\n          <name>DOCKER_REGISTRY_USER<\/name>\n          <description><\/description>\n          <defaultValue>@@{Docker Registry Credential.username}@@<\/defaultValue>\n          <trim>false<\/trim>\n        <\/hudson.model.StringParameterDefinition>\n        <hudson.model.PasswordParameterDefinition>\n          <name>DOCKER_REGISTRY_PASSWORD<\/name>\n          <description><\/description>\n          <defaultValue>@@{Docker Registry Credential.secret}@@<\/defaultValue>\n        <\/hudson.model.PasswordParameterDefinition>\n        <hudson.model.StringParameterDefinition>\n          <name>DOCKER_REGISTRY<\/name>\n          <description><\/description>\n          <defaultValue>@@{Docker Registry.name}@@.@@{domain_name}@@<\/defaultValue>\n          <trim>false<\/trim>\n        <\/hudson.model.StringParameterDefinition>\n        <hudson.model.StringParameterDefinition>\n          <name>REPO_NAME<\/name>\n          <description><\/description>\n          <defaultValue>@@{new_project_name}@@<\/defaultValue>\n          <trim>false<\/trim>\n        <\/hudson.model.StringParameterDefinition>\n      <\/parameterDefinitions>\n    <\/hudson.model.ParametersDefinitionProperty>\n  <\/properties>\n  <definition class=\"org.jenkinsci.plugins.workflow.cps.CpsScmFlowDefinition\" plugin=\"workflow-cps@2.54\">\n    <scm class=\"hudson.plugins.git.GitSCM\" plugin=\"git@3.9.1\">\n      <configVersion>2<\/configVersion>\n      <userRemoteConfigs>\n        <hudson.plugins.git.UserRemoteConfig>\n          <url>git@@@{Gitolite.name}@@.@@{domain_name}@@:@@{new_project_name}@@.git<\/url>\n          <credentialsId>Jenkins<\/credentialsId>\n        <\/hudson.plugins.git.UserRemoteConfig>\n      <\/userRemoteConfigs>\n      <branches>\n        <hudson.plugins.git.BranchSpec>\n          <name>*\/master<\/name>\n        <\/hudson.plugins.git.BranchSpec>\n      <\/branches>\n      <doGenerateSubmoduleConfigurations>false<\/doGenerateSubmoduleConfigurations>\n      <submoduleCfg class=\"list\"\/>\n      <extensions\/>\n    <\/scm>\n    <scriptPath>Jenkinsfile<\/scriptPath>\n    <lightweight>true<\/lightweight>\n  <\/definition>\n  <triggers\/>\n  <authToken>ThisIsTheAPITokenToUse<\/authToken>\n  <disabled>false<\/disabled>\n<\/flow-definition>' | sudo su -c 'tee ~\/jobs\/@@{new_project_name}@@\/config.xml' - jenkins\n\nsudo su -c 'chmod 644 ~\/jobs\/@@{new_project_name}@@\/config.xml' - jenkins\nsudo su -c 'chmod 644 ~\/jobs\/@@{new_project_name}@@\/nextBuildNumber' - jenkins\nsudo su -c 'chmod 644 ~\/jobs\/@@{new_project_name}@@\/builds\/legacyIds' - jenkins\n\necho \"Create @@{new_project_name}@@ App Deploy Job\"\nsudo su -c 'mkdir -p ~\/jobs\/@@{new_project_name}@@_deploy\/builds' - jenkins\nsudo su -c 'touch ~\/jobs\/@@{new_project_name}@@_deploy\/builds\/legacyIds' - jenkins\nsudo su -c 'echo 1 > ~\/jobs\/@@{new_project_name}@@_deploy\/nextBuildNumber' - jenkins\necho '<?xml version=\"1.1\" encoding=\"UTF-8\"?>\n<flow-definition plugin=\"workflow-job@2.23\">\n  <actions\/>\n  <description><\/description>\n  <keepDependencies>false<\/keepDependencies>\n  <properties>\n    <hudson.model.ParametersDefinitionProperty>\n      <parameterDefinitions>\n        <hudson.model.StringParameterDefinition>\n          <name>ARTIFACTORY_IP<\/name>\n          <description><\/description>\n          <defaultValue>@@{Artifactory.address}@@<\/defaultValue>\n          <trim>false<\/trim>\n        <\/hudson.model.StringParameterDefinition>\n        <hudson.model.StringParameterDefinition>\n          <name>REPO_NAME<\/name>\n          <description><\/description>\n          <defaultValue><\/defaultValue>\n          <trim>false<\/trim>\n        <\/hudson.model.StringParameterDefinition>\n        <hudson.model.StringParameterDefinition>\n          <name>BUILD_NUMBER<\/name>\n          <description><\/description>\n          <defaultValue><\/defaultValue>\n          <trim>false<\/trim>\n        <\/hudson.model.StringParameterDefinition>\n      <\/parameterDefinitions>\n    <\/hudson.model.ParametersDefinitionProperty>\n  <\/properties>\n  <definition class=\"org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition\" plugin=\"workflow-cps@2.54\">\n    <script>import groovy.json.JsonSlurperClassic\nimport groovy.json.JsonOutput\n\nnode() {\n    stage(&apos;Deploy Application Via Calm&apos;){\n        echo &quot;Application deployment visual&quot;\n    }\n}\n\ndef response = httpRequest authentication: &apos;PC-User&apos;, consoleLogResponseBody: false, customHeaders: [[maskValue: false, name: &apos;Content-Type&apos;, value: &apos;application\/json&apos;]], ignoreSslErrors: true, responseHandle: &apos;LEAVE_OPEN&apos;, url: &apos;https:\/\/@@{pc_instance_ip}@@:9440\/api\/nutanix\/v3\/blueprints\/@@{app_deploy_blueprint_uuid}@@&apos;\n\nprintln(&quot;Status: &quot; + response.status)\n\/\/println(&quot;Content: &quot; + response.content)\n\ndef blueprint_spec = parseJSON(response.content)\ndef bp_index = 0\ndef var_index = 0\nblueprint_spec.remove(&apos;status&apos;)\nblueprint_spec[&apos;spec&apos;].remove(&apos;name&apos;)\nblueprint_spec[&apos;spec&apos;][&apos;application_name&apos;] = REPO_NAME + &apos;@@{calm_random}@@Jenkins&apos; + BUILD_NUMBER.toString()\nblueprint_spec[&apos;spec&apos;][&apos;app_profile_reference&apos;] = parseJSON(&apos;{&quot;kind&quot;: &quot;app_profile&quot;, &quot;uuid&quot;: &quot;@@{app_profile_uuid}@@&quot;}&apos;)\nblueprint_spec[&apos;metadata&apos;][&apos;owner_reference&apos;] = parseJSON(&apos;{&quot;kind&quot;: &quot;user&quot;, &quot;uuid&quot;: &quot;00000000-0000-0000-0000-000000000000&quot;, &quot;name&quot;: &quot;admin&quot;}&apos;)\nblueprint_spec[&apos;spec&apos;][&apos;resources&apos;][&apos;app_profile_list&apos;].each  { profileKey, profileRow -&gt; \n    println(&quot;Profile: ${profileKey}&quot;); \n    profileKey[&apos;variable_list&apos;].each { variableKey, variableRow -&gt;\n        println(&quot;Variable: ${variableKey}&quot;); \n        if (variableKey[&apos;name&apos;] == &apos;build_number&apos;){\n                blueprint_spec[&apos;spec&apos;][&apos;resources&apos;][&apos;app_profile_list&apos;][bp_index][&apos;variable_list&apos;][var_index][&apos;value&apos;] = BUILD_NUMBER.toString()\n        } else if (variableKey[&apos;name&apos;] == &apos;project_name&apos;){\n                blueprint_spec[&apos;spec&apos;][&apos;resources&apos;][&apos;app_profile_list&apos;][bp_index][&apos;variable_list&apos;][var_index][&apos;value&apos;] = REPO_NAME\n        } else if (variableKey[&apos;name&apos;] == &apos;artifactory_ip&apos;){\n                blueprint_spec[&apos;spec&apos;][&apos;resources&apos;][&apos;app_profile_list&apos;][bp_index][&apos;variable_list&apos;][var_index][&apos;value&apos;] = ARTIFACTORY_IP\n        }\n        var_index += 1;\n    }; \n    bp_index += 1;\n}\n\/\/println(&quot;Content: &quot; + blueprint_spec)\n\ndef payload = JsonOutput.toJson(blueprint_spec)\nprintln(&quot;Payload: &quot; + payload)\n\ndef result = httpRequest authentication: &apos;PC-User&apos;, consoleLogResponseBody: true, customHeaders: [[maskValue: false, name: &apos;Content-Type&apos;, value: &apos;application\/json&apos;], [maskValue: false, name: &apos;Accept&apos;, value: &apos;application\/json&apos;]], httpMode: &apos;POST&apos;, requestBody: payload, ignoreSslErrors: true, responseHandle: &apos;LEAVE_OPEN&apos;, url: &apos;https:\/\/@@{pc_instance_ip}@@:9440\/api\/nutanix\/v3\/blueprints\/@@{app_deploy_blueprint_uuid}@@\/launch&apos;\nprintln(&quot;Status: &quot; + response.status)\nprintln(&quot;Content: &quot; + response.content)\n\ndef parseJSON(json) {\n    return new groovy.json.JsonSlurperClassic().parseText(json)\n}\n<\/script>\n    <sandbox>true<\/sandbox>\n  <\/definition>\n  <triggers\/>\n  <disabled>false<\/disabled>\n<\/flow-definition>'  | sudo su -c 'tee ~\/jobs\/@@{new_project_name}@@_deploy\/config.xml' - jenkins\n\nsudo su -c 'chmod 644 ~\/jobs\/@@{new_project_name}@@_deploy\/config.xml' - jenkins\nsudo su -c 'chmod 644 ~\/jobs\/@@{new_project_name}@@_deploy\/nextBuildNumber' - jenkins\nsudo su -c 'chmod 644 ~\/jobs\/@@{new_project_name}@@_deploy\/builds\/legacyIds' - jenkins","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Developer Workstation"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Initialize Workstation Git Repository","attrs":{"exit_status":[],"script":"echo \"Initialize DevOps Git Project\"\ngit clone git@@@{Gitolite.name}@@.@@{domain_name}@@:@@{new_project_name}@@.git\n\ncd @@{new_project_name}@@\n\ngit config user.name nutanix\ngit config user.email nutanix@@@{name}@@.@@{domain_name}@@\ngit config --global push.default matching\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Restart Jenkins Service","attrs":{"exit_status":[],"script":"sudo systemctl restart jenkins","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Developer Workstation"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Download Version 1 Demo Code","attrs":{"exit_status":[],"script":"echo \"Get Demo Code\"\ncd @@{new_project_name}@@\nwget @@{new_code_seed_location}@@\/@@{new_code_seed}@@\ntar xvfz @@{new_code_seed}@@\nrm @@{new_code_seed}@@\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Wait for Restart","attrs":{"exit_status":[],"script":"echo 'Wait for Jenkins Instance Restart'\nsleep 30","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Jenkins Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Create Git Hook","attrs":{"exit_status":[],"script":"echo 'StrictHostKeyChecking no' > ~\/.ssh\/config\necho \"Create Hook\"\nssh @@{Gitolite.address}@@ 'printf \"#!\/bin\/bash\\n\/usr\/bin\/curl --user admin:@@{jenkins_authorization}@@ -s http:\/\/@@{address}@@:8080\/job\/@@{new_project_name}@@\/buildWithParameters?token=ThisIsTheAPITokenToUse\\n\" | sudo su -c \"tee ~\/repositories\/@@{new_project_name}@@.git\/hooks\/post-receive\" - git'\nssh @@{Gitolite.address}@@ 'sudo su -c \"chmod 775 ~\/repositories\/@@{new_project_name}@@.git\/hooks\/post-receive\" - git'\necho \"Complete Hook\"","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Developer Workstation"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Create and Push Docker Images","attrs":{"exit_status":[],"script":"export DOCKER_REGISTRY=@@{Docker Registry.name}@@.@@{domain_name}@@\nexport PROJECT_NAME=@@{new_project_name}@@\necho \"Login into Docker Registry\"\ndocker login -u @@{Docker Registry Credential.username}@@ -p @@{Docker Registry Credential.secret}@@ $DOCKER_REGISTRY\ncd ~\/@@{new_project_name}@@\n\necho \"Build and Push Ansible Image\"\ndocker build -t ${DOCKER_REGISTRY}\/@@{new_project_name}@@\/ansible docker-ansible\/src\ndocker push ${DOCKER_REGISTRY}\/@@{new_project_name}@@\/ansible\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"3a932271_runbook","main_task_local_reference":{"kind":"app_task","name":"efbcbb73_dag"},"variable_list":[{"val_type":"STRING","description":"","name":"new_app_deploy_blueprint","type":"LOCAL","value":"CICD Application Deployment F5 VMs","label":"","attrs":{"type":""},"editables":{"value":true}},{"val_type":"STRING","description":"","name":"new_code_seed","type":"LOCAL","value":"cicd-demo-v1.tar.gz","label":"","attrs":{"type":""},"editables":{"value":true}},{"val_type":"STRING","description":"","name":"new_code_seed_location","type":"LOCAL","value":"http:\/\/10.1.176.73\/artifacts","label":"","attrs":{"type":""},"editables":{"value":true}},{"val_type":"STRING","description":"","name":"new_project_name","type":"LOCAL","value":"demo","label":"","attrs":{"type":""},"editables":{"value":true}}]},"name":"Add Pipeline"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Task1"}],"name":"52bb136c_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_blueprint_deployment","name":"aa65c031_deployment"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Task1","attrs":{"scaling_count":"2","type":"","scaling_type":"SCALEIN"},"timeout_secs":"0","type":"SCALING","variable_list":[]}],"description":"","name":"ab270777_runbook","main_task_local_reference":{"kind":"app_task","name":"52bb136c_dag"},"variable_list":[]},"name":"Scale Down Dev Workstation"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Scale Down"}],"name":"d7562e3b_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_blueprint_deployment","name":"8cafc62e_deployment"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Scale Down","attrs":{"scaling_count":"1","type":"","scaling_type":"SCALEIN"},"timeout_secs":"0","type":"SCALING","variable_list":[]}],"description":"","name":"31c4de29_runbook","main_task_local_reference":{"kind":"app_task","name":"d7562e3b_dag"},"variable_list":[]},"name":"Scale Down Jenkins Slave"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Scale UP"}],"name":"b536d0d0_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_blueprint_deployment","name":"aa65c031_deployment"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Scale UP","attrs":{"scaling_count":"2","type":"","scaling_type":"SCALEOUT"},"timeout_secs":"0","type":"SCALING","variable_list":[]}],"description":"","name":"f3252490_runbook","main_task_local_reference":{"kind":"app_task","name":"b536d0d0_dag"},"variable_list":[]},"name":"Scale Up Dev Workstation"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Scale Up"}],"name":"ae22a5e6_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_blueprint_deployment","name":"8cafc62e_deployment"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Scale Up","attrs":{"scaling_count":"1","type":"","scaling_type":"SCALEOUT"},"timeout_secs":"0","type":"SCALING","variable_list":[]}],"description":"","name":"3801c5df_runbook","main_task_local_reference":{"kind":"app_task","name":"ae22a5e6_dag"},"variable_list":[]},"name":"Scale Up Jenkins Slave"}],"name":"Default","variable_list":[{"val_type":"STRING","description":"","name":"domain_name","type":"LOCAL","value":"gso.lab","label":"","attrs":{"type":""},"editables":{"value":true}},{"val_type":"STRING","description":"","name":"initial_app_deploy_blueprint","type":"LOCAL","value":"CICD-App2","label":"","attrs":{"type":""},"editables":{"value":true}},{"val_type":"STRING","description":"","name":"initial_code_seed","type":"LOCAL","value":"cicd-demo-v1.tar.gz","label":"","editables":{"value":true}},{"val_type":"STRING","description":"","name":"initial_code_seed_location","type":"LOCAL","value":"https:\/\/s3.ap-northeast-2.amazonaws.com\/panlm-images","label":"","attrs":{"type":""},"editables":{"value":true}},{"val_type":"STRING","description":"","name":"initial_project_name","type":"LOCAL","value":"devops","label":"","attrs":{"type":""},"editables":{"value":true}},{"val_type":"STRING","description":"","name":"jenkins_public_key","type":"LOCAL","value":"ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEApFiiPDXZ\/in4yknwl33rQkVi3Oo4X\/78ekW93+gGptbV1wCj\/PFay85\/aMA98ZYaAxXoC+MHe3QgUuXER45poH552IWdF0tU7X\/t0jH5KllVFx2yuFzCcjw1aKwdxKagDLX5jP4QvNsvB9pKx4dwECBp4qlKW4cpl\/2cWEpUqRi67PVDYr3TMt\/OCac6FaAMs5Du3N2HhGiWh2wezqUCRameLdni1\/G3ovaKpGL+c68n0peBsK63AJEa+AjVfpFcz6kzEUUMGSvAWD2d5nKCkJzqfBgh6kFJUTXPX0YnorbGsp1SuxmLy1pD7RXh2it5IPFUAFgEQfBwJJd7L4UkWQ== root@centos","label":""},{"val_type":"STRING","description":"","name":"nutanix_public_key","type":"LOCAL","value":"ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEApFiiPDXZ\/in4yknwl33rQkVi3Oo4X\/78ekW93+gGptbV1wCj\/PFay85\/aMA98ZYaAxXoC+MHe3QgUuXER45poH552IWdF0tU7X\/t0jH5KllVFx2yuFzCcjw1aKwdxKagDLX5jP4QvNsvB9pKx4dwECBp4qlKW4cpl\/2cWEpUqRi67PVDYr3TMt\/OCac6FaAMs5Du3N2HhGiWh2wezqUCRameLdni1\/G3ovaKpGL+c68n0peBsK63AJEa+AjVfpFcz6kzEUUMGSvAWD2d5nKCkJzqfBgh6kFJUTXPX0YnorbGsp1SuxmLy1pD7RXh2it5IPFUAFgEQfBwJJd7L4UkWQ== root@centos","label":""},{"val_type":"STRING","description":"","name":"pc_instance_ip","type":"LOCAL","value":"10.139.80.4","label":"","attrs":{"type":""},"editables":{"value":true}}]}],"published_service_definition_list":[],"default_credential_local_reference":{"kind":"app_credential","name":"Ubuntu Credential"},"type":"USER"},"name":"CICD-Base2"},"api_version":"3.0","metadata":{"last_update_time":"1553224311393704","kind":"blueprint","spec_version":5,"creation_time":"1553211811677610","name":"CICD-Base2"}}